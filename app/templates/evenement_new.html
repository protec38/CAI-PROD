<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gestion des √©v√®nements</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="csrf-token" content="{{ csrf_token() }}"/>

  <style>
    :root{
      --pc-blue:#003b71;
      --pc-blue-2:#0a2f57;
      --pc-orange:#f58220;
      --ink:#0f172a;
      --muted:#667085;
      --line:#e6edf5;
      --bg:#f6f8fc;
      --card:#ffffff;
      --radius:16px;
      --gap:18px;
      --shadow:0 10px 24px rgba(16,24,40,.06);
    }

    /* base */
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font: 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, Noto Sans;
      color: var(--ink);
      background: var(--bg);
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    /* header */
    .header{
      background: linear-gradient(180deg, var(--pc-blue), #002b52);
      color:#fff; text-align:center; padding:18px 12px;
      border-bottom: 4px solid var(--pc-orange);
    }
    .header .brand{
      display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap;
    }
    .logo{
      width:54px; height:54px; border-radius:14px; display:grid; place-items:center;
      background: linear-gradient(135deg, var(--pc-orange), #ff9f49); color:#112944; font-weight:900;
      box-shadow: inset 0 2px 10px rgba(0,0,0,.15);
    }
    .header h1{margin:0; font-size: clamp(20px, 2.4vw, 28px); letter-spacing:.3px;}
    .header p{margin:.25rem 0 0 0; opacity:.9; font-weight:600}

    /* container */
    .container{
      width: min(940px, 94vw);
      margin: 22px auto 30px;
      display: grid; gap: var(--gap);
    }

    /* cartes */
    .card{
      background: var(--card); border:1px solid var(--line); border-radius: var(--radius);
      box-shadow: var(--shadow); overflow: hidden;
    }
    .card .hd{
      padding: 14px 16px; border-bottom:1px solid var(--line);
      background: linear-gradient(180deg,#fff,#f8fbff);
      color: var(--pc-blue); font-weight:900; letter-spacing:.2px;
    }
    .card .bd{ padding: 16px; }

    /* boutons principaux */
    .btns{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
      padding: 14px; border:1px dashed var(--line); border-radius: 14px; background:#fff;
    }
    .btn{
      display:inline-flex; align-items:center; gap:8px; padding:12px 16px; border-radius:12px;
      border:1px solid #dbe6ff; background:#eef3ff; color:var(--pc-blue); font-weight:900;
      text-decoration:none; cursor:pointer;
      transition: transform .04s ease, filter .15s ease;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.warn{ background:#fff1e6; color:#9b4600; border-color:#ffd8bd; }
    .btn.admin{ background:#eaf7ff; color:#035388; border-color:#c6e7ff; }

    /* formulaires */
    label{ font-weight:800; color: var(--muted); text-transform:uppercase; font-size:.85rem; letter-spacing:.04em; }
    .field{ display:grid; gap:6px; }
    .field + .field{ margin-top: 12px; }
    input[type="text"], select{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--line); background:#fff; font:inherit;
    }

    .form-actions{ margin-top:14px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
    .submit{ background: var(--pc-orange); border:1px solid #ffcfad; color:#fff; }
    .submit:hover{ filter: brightness(1.03); }

    /* flash */
    .flash{ padding: 12px 16px; border-radius:12px; border:1px solid transparent; font-weight:800; text-align:center; }
    .flash-success{ background:#ecfdf3; border-color:#abefc6; color:#067647; }
    .flash-danger{ background:#fef3f2; border-color:#fecdcf; color:#b42318; }
    .flash-warning{ background:#fffaeb; border-color:#fedf89; color:#b54708; }
    .flash-info{ background:#eff8ff; border-color:#b2ddff; color:#175cd3; }

    /* sections */
    .section{ background:#fff; border:1px solid var(--line); border-radius:16px; padding:16px; }
    .section h2{ margin:6px 0 14px; color: var(--pc-blue); font-size: 20px; text-align:center; }

    /* statut affiche */
    #statut-selectionne{ margin-top:10px; font-weight:900; color: var(--pc-blue); }

    /* responsive */
    @media (max-width: 560px){
      .btns{ display:grid; grid-template-columns: 1fr; }
      .form-actions{ justify-content:stretch; }
      .form-actions .btn{ width:100%; justify-content:center; }
    }
  </style>
</head>
<body>

  <!-- ===== Header ===== -->
  <header class="header">
    <div class="brand">
      <div class="logo">PC</div>
      <div>
        <h1>Protection Civile ‚Äî Gestion des √©v√®nements</h1>
        <p>Cr√©er ou rejoindre rapidement un √©v√®nement</p>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- ===== Flash messages ===== -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div id="flash-messages">
          {% for category, message in messages %}
            <div class="flash flash-{{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
        <script>
          setTimeout(() => {
            const f = document.getElementById("flash-messages");
            if (f) f.style.display = "none";
          }, 8000);
        </script>
      {% endif %}
    {% endwith %}

    <!-- ===== 1) Boutons d'acc√®s (en premier) ===== -->
    <section class="card">
      <div class="hd">Acc√®s rapide</div>
      <div class="bd">
        <div class="btns">
          <a href="{{ url_for('main_bp.logout') }}" class="btn warn">üö™ D√©connexion</a>
          <a href="{{ url_for('main_bp.admin_utilisateurs') }}" class="btn">üë• G√©rer les utilisateurs</a>
          {% if user.is_admin or user.role == "codep" %}
            <a href="{{ url_for('main_bp.admin_evenements') }}" class="btn admin">üõ† Modifier les √©v√®nements</a>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- ===== 2) Rejoindre un √©v√®nement ===== -->
    <section class="card">
      <div class="hd">Rejoindre un √©v√®nement existant</div>
      <div class="bd">
        <form method="post" action="{{ url_for('main_bp.select_evenement') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="field">
            <label for="evenement_id">S√©lectionner un √©v√®nement</label>
            <select name="evenement_id" id="evenement_id" required onchange="afficherStatut()">
              <option value="" disabled selected>‚Äî Choisir un √©v√®nement ‚Äî</option>
              {% for evt in evenements %}
                <option value="{{ evt.id }}" data-statut="{{ evt.statut }}">{{ evt.nom }} ({{ evt.numero }})</option>
              {% endfor %}
            </select>
          </div>
          <p id="statut-selectionne"></p>
          <div class="form-actions">
            <button type="submit" class="btn submit">‚û°Ô∏è Rejoindre</button>
          </div>
        </form>
      </div>
    </section>

    <!-- ===== 3) Cr√©er un √©v√®nement ===== -->
    <section class="card">
      <div class="hd">Cr√©er un nouvel √©v√®nement</div>
      <div class="bd">
        <form method="post" action="{{ url_for('main_bp.evenement_new') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="field">
            <label for="nom_evt">Nom de l'√©v√®nement</label>
            <input type="text" id="nom_evt" name="nom_evt" required>
          </div>

          <div class="field">
            <label for="type_evt">Type d'√©v√®nement</label>
            <select id="type_evt" name="type_evt" required>
              <option value="CAI">CAI</option>
              <option value="CHU">CHU</option>
              <option value="PRV">PRV</option>
            </select>
          </div>

          <div class="field">
            <label for="adresse">Adresse</label>
            <input type="text" id="adresse" name="adresse" required>
          </div>

          <div class="field">
            <label for="statut">Statut</label>
            <select id="statut" name="statut" required>
              <option value="En cours de gr√©ement">En cours de gr√©ement</option>
              <option value="Ouvert">Ouvert</option>
              <option value="Effectif d√©pass√©">Effectif d√©pass√©</option>
              <option value="Complet">Complet</option>
              <option value="Ferm√©">Ferm√©</option>
            </select>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn submit">‚ûï Cr√©er l'√©v√®nement</button>
          </div>
        </form>
      </div>
    </section>

  </main>

  <script>
    // Affiche le statut de l'√©v√®nement s√©lectionn√©
    function afficherStatut() {
      const select = document.getElementById("evenement_id");
      const opt = select.options[select.selectedIndex];
      const statut = opt ? opt.getAttribute("data-statut") : "";
      document.getElementById("statut-selectionne").innerText = statut ? "Statut : " + statut : "";
    }
  </script>

  <!-- si tu utilises ce helper global c√¥t√© app -->
  <script src="{{ url_for('static', filename='csrf.js') }}"></script>
</body>
</html>
