{% extends "base.html" %}
{% block content %}

<!-- ===== Fix overlap header / responsive tweaks (local styles) ===== -->
<style>
  :root { --nav-h: 64px; }
  /* espace sous navbar fixe */
  .nav-offset { height: var(--nav-h); }
  /* marge de sécurité si base.html met déjà du padding-top */
  .fd-wrap { margin-top: 8px; }

  /* Layouts */
  .fd-hero { background: #f7f9fc; border-radius: 16px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,.05); }
  .fd-hero h2 { margin: 0 0 8px 0; }
  .meta { display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
  .chip { display:inline-flex; align-items:center; gap:6px; background:#eef3ff; color:#003b71; border-radius:999px; padding:6px 10px; font-weight:500; }

  .fd-tiles { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; margin-top:14px; }
  .tile { display:flex; gap:10px; background:white; border:1px solid #e7edf5; border-radius:12px; padding:12px; align-items:center; }
  .tile .k { font-size:.85rem; color:#4a5568; }
  .tile .v { font-weight:600; }

  .timeline { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:14px; }
  .timeline .dot { width:36px; height:36px; border-radius:50%; background:#ffefe3; color:#f58220; display:inline-flex; align-items:center; justify-content:center; }
  .timeline .lbl { font-size:.8rem; color:#6b7280; }
  .timeline .val { font-weight:600; }
  .timeline .sep { flex:1; height:2px; background:linear-gradient(90deg, #ffe1c9, #e7edf5); border-radius:8px; }

  .fd-grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:16px; }
  .fd-card { background:white; border:1px solid #e7edf5; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.04); }
  .fd-section { padding:14px; }
  .fd-section h4 { margin:0 0 10px; display:flex; gap:8px; align-items:center; }

  .fd-list { display:grid; grid-template-columns: 1fr 1fr; column-gap:16px; row-gap:10px; }
  .fd-item { display:grid; grid-template-columns: 180px 1fr; gap:10px; align-items:flex-start; }
  .fd-item .lbl { color:#6b7280; font-weight:500; }
  .fd-item .val { font-weight:600; }

  .fd-badges { display:flex; flex-wrap:wrap; gap:8px; }
  .badge-competence, .badge-bagage {
    display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px;
    background:#f1f5f9; border:1px solid #e7edf5; font-weight:600;
  }
  .statut-pill { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; font-weight:700; }
  .statut-present { background:#e8f6ef; color:#16794d; border:1px solid #c9ecd9; }
  .statut-sorti { background:#fff3d6; color:#8a6100; border:1px solid #ffe7ad; }
  .statut-supprime { background:#fde2e2; color:#b42318; border:1px solid #f9c6c6; }

  .fd-actions { display:flex; flex-wrap:wrap; gap:10px; margin-top:16px; }
  .btn-soft { display:inline-flex; align-items:center; gap:8px; border-radius:10px; padding:8px 12px; text-decoration:none; font-weight:600; border:1px solid transparent; }
  .btn-secondary { background:#eef3ff; color:#003b71; border-color:#dbe6ff; }
  .btn-warning { background:#fff1e6; color:#b35100; border-color:#ffd8bd; }

  /* Timeline (commentaires) */
  section.card { background:white; border:1px solid #e7edf5; border-radius:16px; padding:14px; }
  .timeline-list { margin-top:12px; }
  .timeline-ul { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:12px; }
  .timeline-item { border:1px dashed #e7edf5; border-radius:12px; padding:10px; background:#fcfdff; }
  .timeline-time { font-size:.85rem; color:#6b7280; }
  .timeline-content { margin-top:6px; white-space:pre-wrap; }
  .timeline-meta { margin-top:6px; font-size:.85rem; color:#6b7280; }

  /* Mobile */
  @media (max-width: 1024px) {
    .fd-tiles { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .fd-grid { grid-template-columns: 1fr; }
    .fd-item { grid-template-columns: 1fr; }
  }
  @media (max-width: 480px) {
    :root { --nav-h: 72px; } /* nav un peu plus haute sur mobile */
  }
</style>

<!-- ===== spacer sous navbar fixe ===== -->
<div class="nav-offset" aria-hidden="true"></div>

<div class="fd-wrap">

  <!-- ===== HERO ===== -->
  <div class="fd-hero" id="top">
    <h2>Détail de la fiche impliqué</h2>
    <div class="meta">
      <span class="chip"><i class="fa-solid fa-hashtag"></i> {{ fiche.numero }}</span>
      <span class="chip"><i class="fa-solid fa-user"></i> {{ fiche.nom }} {{ fiche.prenom }}</span>
      <span class="chip">
        {% if fiche.statut == 'présent' %}<i class="fa-solid fa-circle-check"></i>
        {% elif fiche.statut == 'sorti' %}<i class="fa-solid fa-person-walking-arrow-right"></i>
        {% else %}<i class="fa-solid fa-trash-can"></i>{% endif %}
        {{ fiche.statut|capitalize }}
      </span>
    </div>

    <!-- Tuiles de résumé -->
    <div class="fd-tiles">
      <div class="tile">
        <div class="ico"><i class="fa-solid fa-cake-candles"></i></div>
        <div>
          <div class="k">Naissance</div>
          <div class="v">{{ fiche.date_naissance.strftime('%d/%m/%Y') if fiche.date_naissance else '—' }}</div>
        </div>
      </div>
      <div class="tile">
        <div class="ico"><i class="fa-solid fa-barcode"></i></div>
        <div>
          <div class="k">Code Sinus</div>
          <div class="v">{{ fiche.code_sinus or '—' }}</div>
        </div>
      </div>
      <div class="tile">
        <div class="ico"><i class="fa-solid fa-phone"></i></div>
        <div>
          <div class="k">Téléphone</div>
          <div class="v">{{ fiche.telephone or '—' }}</div>
        </div>
      </div>
      <div class="tile">
        <div class="ico"><i class="fa-solid fa-shield-halved"></i></div>
        <div>
          <div class="k">Évènement</div>
          <div class="v">{{ fiche.evenement.nom }}</div>
        </div>
      </div>
    </div>

    <!-- Timeline Arrivée / Sortie -->
    <div class="timeline">
      <div style="display:flex; align-items:center; gap:10px;">
        <span class="dot"><i class="fa-solid fa-arrow-down"></i></span>
        <div>
          <div class="lbl">Arrivée</div>
          <div class="val">{{ fiche.heure_arrivee_locale|default('', true)|length and fiche.heure_arrivee_locale.strftime('%d/%m/%Y %H:%M') or '—' }}</div>
        </div>
      </div>
      <div class="sep"></div>
      <div style="display:flex; align-items:center; gap:10px;">
        <div style="text-align:right">
          <div class="lbl">Sortie</div>
          <div class="val">{{ fiche.heure_sortie_locale|default('', true)|length and fiche.heure_sortie_locale.strftime('%d/%m/%Y %H:%M') or '—' }}</div>
        </div>
        <span class="dot"><i class="fa-solid fa-arrow-up"></i></span>
      </div>
    </div>
  </div>

  <!-- ===== CONTENU ===== -->
  <div class="fd-grid">

    <!-- Colonne gauche : Informations personnelles -->
    <div class="fd-card fd-section">
      <h4><i class="fa-solid fa-id-card-clip"></i> Informations personnelles</h4>
      <div class="fd-list">
        <div class="fd-item">
          <span class="lbl">Nom</span>
          <span class="val">{{ fiche.nom }}</span>
        </div>
        <div class="fd-item">
          <span class="lbl">Prénom</span>
          <span class="val">{{ fiche.prenom }}</span>
        </div>
        <div class="fd-item">
          <span class="lbl">Date de naissance</span>
          <span class="val">{{ fiche.date_naissance.strftime('%d/%m/%Y') if fiche.date_naissance else 'Non renseignée' }}</span>
        </div>
        <div class="fd-item">
          <span class="lbl">Code Sinus</span>
          <span class="val">{{ fiche.code_sinus or 'Non renseigné' }}</span>
        </div>

        <div class="fd-item">
          <span class="lbl">N° prise en charge (Argos/AEP)</span>
          <span class="val">{{ fiche.numero_pec or 'Non renseigné' }}</span>
        </div>

        <div class="fd-item" style="grid-column: span 2;">
          <span class="lbl">Adresse</span>
          <span class="val">{{ fiche.adresse or 'Non renseignée' }}</span>
        </div>
        <div class="fd-item">
          <span class="lbl">Téléphone</span>
          <span class="val">{{ fiche.telephone or 'Non renseigné' }}</span>
        </div>
        <div class="fd-item">
          <span class="lbl">Évènement</span>
          <span class="val">{{ fiche.evenement.nom }}</span>
        </div>
      </div>
    </div>

    <!-- Colonne droite : Statut & infos -->
    <div class="fd-card fd-section">
      <h4><i class="fa-solid fa-circle-info"></i> Statut & informations</h4>

      <div class="fd-list">
        <div class="fd-item">
          <span class="lbl">Statut</span>
          <span class="val">
            {% if fiche.statut == 'présent' %}
              <span class="statut-pill statut-present"><i class="fa-solid fa-circle-check"></i> Présent</span>
            {% elif fiche.statut == 'sorti' %}
              <span class="statut-pill statut-sorti"><i class="fa-solid fa-person-walking-arrow-right"></i> Sorti</span>
            {% else %}
              <span class="statut-pill statut-supprime"><i class="fa-solid fa-trash-can"></i> Supprimé</span>
            {% endif %}
          </span>
        </div>

        <div class="fd-item">
          <span class="lbl">Personne à prévenir</span>
          <span class="val">
            {% if fiche.personne_a_prevenir %}
              {{ fiche.personne_a_prevenir }}{% if fiche.tel_personne_a_prevenir %} – {{ fiche.tel_personne_a_prevenir }}{% endif %}
            {% else %}Non renseigné{% endif %}
          </span>
        </div>

        <div class="fd-item" style="grid-column: span 2;">
          <span class="lbl">Difficultés</span>
          <span class="val">{{ fiche.difficultes or 'Non renseignée' }}</span>
        </div>

        <div class="fd-item" style="grid-column: span 2;">
          <span class="lbl">Autres informations</span>
          <span class="val">{{ fiche.autres_informations or 'Non renseigné' }}</span>
        </div>

        <div class="fd-item">
          <span class="lbl">Destination</span>
          <span class="val">{{ fiche.destination or 'Non renseignée' }}</span>
        </div>

        <div class="fd-item">
          <span class="lbl">Moyen de transport</span>
          <span class="val">{{ fiche.moyen_transport or 'Non renseigné' }}</span>
        </div>

        <div class="fd-item">
          <span class="lbl">Recherche une personne</span>
          <span class="val">{{ fiche.recherche_personne or 'Non' }}</span>
        </div>

        <div class="fd-item" style="grid-column: span 2;">
          <span class="lbl">Compétences</span>
          {% set comps = (fiche.competences or '').split(',') if fiche.competences else [] %}
          {% if comps %}
            <div class="fd-badges">
              {% for c in comps %}
                {% set t = c.strip() %}
                {% set cls =
                  'medecin' if t=='Médecin'
                  else 'infirmier' if t=='Infirmier'
                  else 'pompier' if t=='Sapeur-pompier'
                  else 'sst' if t=='SST'
                  else 'psy' if t=='Psychologue'
                  else 'benevole' if t=='Bénévole'
                  else 'artisan' if t=='Artisan'
                  else 'interprete' if t=='Interprète'
                  else 'logisticien' if t=='Logisticien'
                  else 'conducteur' if t=='Conducteur'
                  else 'securite' if t=='Agent sécurité'
                  else 'autre' %}
                <span class="badge-competence {{ cls }}"><i class="fa-solid fa-award"></i> {{ t }}</span>
              {% endfor %}
            </div>
          {% else %}
            <span class="val">Non renseignée</span>
          {% endif %}
        </div>

        <div class="fd-item" style="grid-column: span 2;">
          <span class="lbl">Bagages</span>
          {% if fiche.bagages and fiche.bagages|length > 0 %}
            <div class="fd-badges">
              {% for bag in fiche.bagages %}
                <span class="badge-bagage"><i class="fa-solid fa-suitcase-rolling"></i> {{ bag.numero }}</span>
              {% endfor %}
            </div>
          {% else %}
            <span class="val">Aucun</span>
          {% endif %}
        </div>
      </div>
    </div>

  </div>

  <!-- ===== Actions ===== -->
  <div class="fd-actions">
    <a href="{{ url_for('main_bp.dashboard', evenement_id=fiche.evenement.id) }}" class="btn-soft btn-secondary">
      <i class="fa-solid fa-arrow-left-long"></i> Retour au dashboard
    </a>
    <a href="{{ url_for('main_bp.export_pdf_fiche', id=fiche.id) }}" class="btn-soft btn-warning">
      <i class="fa-solid fa-file-pdf"></i> Exporter en PDF
    </a>
  </div>
</div>

<section id="timeline" class="card" style="margin-top:16px; scroll-margin-top: var(--nav-h);">
  <h2>Suivi / Timeline</h2>
  <!-- ⚠️ aligne le nom du champ avec ton modèle Entry (content) -->
  <form method="post" action="{{ url_for('main_bp.add_timeline_comment', fiche_id=fiche.id) }}" class="row" style="display:flex; gap:8px; align-items:flex-start;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <textarea name="content" rows="3" placeholder="Ajouter un commentaire de suivi..." style="flex:1; width:100%;"></textarea>
    <button class="btn-soft btn-secondary" type="submit"><i class="fa-solid fa-plus"></i> Ajouter</button>
  </form>

  <div class="timeline-list">
    {% if not entries %}
      <p class="muted">Aucun commentaire pour l'instant.</p>
    {% else %}
      <ul class="timeline-ul">
        {% for e in entries %}
          <li class="timeline-item" id="entry-{{ e.id }}" style="scroll-margin-top: calc(var(--nav-h) + 8px);">
            <div class="timeline-time">{{ e.created_at|fr_datetime }}</div>
            <div class="timeline-content">{{ (e.content or e.message)|e }}</div>
            <div class="timeline-meta">par #{{ e.user_id }}</div>
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>
</section>

{% endblock %}
