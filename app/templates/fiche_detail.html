<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Fiche impliqué — {{ fiche.nom }} {{ fiche.prenom }}</title>

<style>
/* ===== Reset & thème ===== */
*,*::before,*::after{box-sizing:border-box}
html,body{margin:0;padding:0}
:root{
  --pc-blue:#003b71; --pc-blue-2:#0a2f57; --pc-orange:#f58220; --pc-amber:#ffcc00;
  --bg:#0e1626; --bg2:#0a1220; --card:#101b2c; --card-2:#0d1727; --line:#1f2f49;
  --ink:#e8f0ff; --muted:#9fb0c9; --ok:#1bb386; --warn:#ffb224; --err:#ff6b6b;
  --radius:16px; --gap:18px; --shadow:0 10px 30px rgba(0,0,0,.35);
  --container:min(1200px, calc(100vw - 32px));
}
body{
  font: 14.5px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, Noto Sans, "Apple Color Emoji","Segoe UI Emoji";
  color:var(--ink);
  background:
    radial-gradient(1200px 500px at -10% -10%, rgba(0,59,113,.55), transparent 65%),
    radial-gradient(900px 420px at 110% -10%, rgba(245,130,32,.25), transparent 65%),
    linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
}

/* ===== Barre top collante ===== */
.header{
  position:sticky; top:0; z-index:50;
  backdrop-filter:saturate(130%) blur(10px);
  background:linear-gradient(180deg, rgba(16,27,44,.85), rgba(16,27,44,.65));
  border-bottom:1px solid var(--line);
}
.header .inner{
  max-width:var(--container); margin:auto; padding:12px 20px;
  display:flex; gap:14px; align-items:center; justify-content:space-between;
}
.brand{display:flex; gap:12px; align-items:center}
.badge{
  width:40px; height:40px; border-radius:12px; display:grid; place-items:center;
  background:linear-gradient(135deg, var(--pc-orange), #ff9f49); color:#1b2742; font-weight:900;
  box-shadow:inset 0 2px 10px rgba(0,0,0,.15);
}
.title{margin:0;font-size:20px;letter-spacing:.3px;color:#cfe0ff}
.subtitle{color:var(--muted);font-weight:600;font-size:13px}
.topchips{display:flex;gap:8px;flex-wrap:wrap}

/* ===== Boutons header (très visibles) ===== */
.top-actions{
  display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-left:12px;
}
.btn{
  display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;
  font-weight:900;text-decoration:none;border:1px solid var(--line);
  color:#d6e5ff; background:#0f223d; transition:transform .08s ease, filter .15s ease, box-shadow .15s ease;
}
.btn:active{ transform:translateY(1px) }
.btn.primary{
  color:#0b1220;
  background:linear-gradient(135deg, #ffd36a, var(--pc-orange));
  border-color:rgba(0,0,0,.15);
  box-shadow:0 6px 18px rgba(245,130,32,.35), inset 0 1px 0 rgba(255,255,255,.35);
}
.btn.primary:hover{ filter:brightness(1.02) }
.btn.secondary{
  color:#e9f2ff; background:#17345e; border-color:#2e5ea8;
  box-shadow:0 6px 18px rgba(46,94,168,.25), inset 0 1px 0 rgba(255,255,255,.06);
}
.btn.secondary:hover{ filter:brightness(1.05) }

.chip{
  display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
  background:#0f223d;border:1px solid var(--line);color:#cfe0ff;font-weight:700;
}

.age-badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 10px;
  border-radius:999px;
  background:rgba(255,211,106,.18);
  color:#ffd36a;
  font-weight:800;
  font-size:0.85rem;
  margin-left:8px;
  white-space:nowrap;
}

/* ===== Wrap ===== */
.wrapper{max-width:var(--container); margin:20px auto; padding:0 20px;}

/* ===== Hero / méta fiche ===== */
.hero{
  border:1px solid var(--line); border-radius:calc(var(--radius) + 4px);
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  box-shadow:var(--shadow); padding:18px 18px 10px 18px;
}
.hero h1{
  margin:0; font-size: clamp(22px, 2.6vw, 32px); color:#d8e6ff; letter-spacing:.4px;
}
.hero .meta{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
.hero .pill{
  display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; font-weight:800;
  border:1px solid var(--line);
}
.p-ok{background:rgba(27,179,134,.22); color:#bff1e3}
.p-warn{background:rgba(255,178,36,.22); color:#ffe7b3}
.p-err{background:rgba(255,107,107,.22); color:#ffd4d4}

/* === Barre horaires (arrivée / sortie) === */
.timebar{
  margin-top:12px;
  display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:14px;
}
.timebar .bar{ height:3px; width:100%; background:linear-gradient(90deg,#ffd7bd,#e1eaf8); border-radius:3px; }
.timegroup .lbl{ color:var(--muted); font-size:.9rem; margin-bottom:3px; }
.timegroup .val{ font-weight:900; color:#eaf2ff; }

/* ===== Tuiles recap ===== */
.tiles{display:grid; gap:12px; margin-top:14px; grid-template-columns: repeat(4, minmax(210px, 1fr));}
.tile{
  background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px;
  display:flex; gap:10px; align-items:center;
}
.ico{width:34px; height:34px; border-radius:10px; display:grid; place-items:center; background:#122540;border:1px solid var(--line)}
.k{font-size:.85rem;color:var(--muted);font-weight:700}
.v{font-weight:900}

/* ===== Grille principale ===== */
.grid{
  display:grid; gap:var(--gap); margin-top:var(--gap);
  grid-template-columns: 1.2fr 1fr;
}
.card{
  background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
  overflow:hidden;
}
.card .hd{
  padding:12px 16px; border-bottom:1px solid var(--line);
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  font-weight:900; letter-spacing:.3px; color:#d6e5ff;
}
.card .bd{ padding:16px; }

/* ===== Champs ===== */
.fields{ display:grid; gap:12px; grid-template-columns: repeat(2, minmax(260px, 1fr)); }
.field{ border:1px solid var(--line); border-radius:12px; padding:12px; background:#0e1f36; }
.label{ color:var(--muted); font-weight:800; font-size:.85rem; letter-spacing:.04em; text-transform:uppercase; margin-bottom:6px; }
.value{ color:#e8f0ff; font-weight:900; font-size:1.05rem; line-height:1.45; word-break:break-word; }
.field.full{ grid-column: 1 / -1; }

.badges{display:flex;gap:8px;flex-wrap:wrap}
.tag{border:1px solid var(--line); background:#0d243f; color:#dbe7ff; border-radius:999px; padding:8px 10px; font-weight:800}

/* ===== Actions locales (section infos) ===== */
.actions{
  display:flex;gap:10px;flex-wrap:wrap;margin-top:12px; justify-content:flex-end;
}
.btn.warn{ background:rgba(245,130,32,.18); border-color:#2a3b54; color:#ffd9bd }

/* ===== Timeline ===== */
.timeline{ margin-top:18px; }
.timeline .bd{ padding:0 0 8px 0; }
.tform-wrap{
  background:var(--card); border:1px dashed var(--line); border-radius:12px;
  padding:12px; margin-bottom:14px;
}
.tform{ display:flex; gap:12px; align-items:flex-start; }
.tform textarea{
  flex:1; min-height:110px; resize:vertical; padding:12px; border-radius:12px; border:1px solid var(--line);
  background:#0e1f36; color:#e8f0ff; font:inherit;
}
.tform button{ border:1px solid var(--line); background:#0f223d; color:#d6e5ff; border-radius:12px; padding:12px 16px; font-weight:900 }

/* ligne verticale */
.tline{ position:relative; padding-left:28px; }
.tline::before{
  content:""; position:absolute; left:12px; top:0; bottom:0; width:2px; background:#203453; border-radius:2px;
}
.titem{
  position:relative; margin:0 0 14px 0; padding:10px 12px; background:#0e1f36; border:1px solid var(--line); border-radius:12px;
}
.titem::before{
  content:""; position:absolute; left:6px; top:16px; width:12px; height:12px; border-radius:50%;
  background:#ffd9bd; border:2px solid #243a5f;
  box-shadow:0 0 0 4px rgba(245,130,32,.12);
}
.ttime{ color:var(--muted); font-size:.95rem; margin-bottom:6px; }
.tcontent{ white-space:pre-wrap; color:#e8f0ff; font-weight:800; }
.tmeta{ margin-top:6px; color:var(--muted); font-size:.9rem; }

/* ===== Responsive ===== */
@media (max-width: 1200px){
  .grid{ grid-template-columns: 1fr; }
}
@media (max-width: 980px){
  :root{ --container:min(980px, calc(100vw - 28px)); }
  .header .inner{ flex-direction:column; align-items:flex-start; }
  .brand{ width:100%; }
  .topchips{ width:100%; justify-content:flex-start; }
  .top-actions{ width:100%; justify-content:space-between; }
  .top-actions .btn{ flex:1; justify-content:center; }
  .hero{ padding:16px; }
  .hero .meta{ flex-direction:column; align-items:flex-start; }
  .timebar{ grid-template-columns:1fr; gap:10px; }
  .timebar .bar{ display:none; }
  .tiles{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
  .fields{ grid-template-columns:1fr; }
}
@media (max-width: 720px){
  :root{ --container:min(720px, calc(100vw - 24px)); }
  .wrapper{ padding:0 16px; }
  .header .inner{ gap:16px; }
  .topchips{ gap:6px; }
  .chip{ width:100%; justify-content:center; }
  .tiles{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
  .tile{ align-items:flex-start; }
  .top-actions{ flex-direction:column; gap:8px; }
  .top-actions .btn{ width:100%; }
  .actions{ flex-direction:column; align-items:stretch; }
  .actions .btn{ width:100%; justify-content:center; }
  .tform{ flex-direction:column; }
  .tform button{ width:100%; }
}
@media (max-width: 540px){
  :root{ --container:calc(100vw - 20px); }
  body{ font-size:14px; }
  .wrapper{ padding:0 12px; }
  .title{ display:block; }
  .title .subtitle{ display:block; }
  .brand{ flex-direction:column; align-items:flex-start; }
  .topchips{ flex-direction:column; }
  .tiles{ grid-template-columns:1fr; }
  .hero{ padding:16px 14px; }
  .hero .meta{ gap:8px; }
  .timegroup{ text-align:left !important; }
  .tile{ gap:12px; }
  .card .bd{ padding:14px; }
  .field{ padding:12px 10px; }
  .tform textarea{ min-height:140px; }
}
</style>
</head>
<body>

{% include "_flashes.html" %}

<!-- ===== Barre supérieure ===== -->
<header class="header">
  <div class="inner">
    <div class="brand">
      <div class="badge">PC</div>
      <div>
        <h2 class="title">Protection Civile — CAI</h2>
        <div class="subtitle">Centre d’Accueil des Impliqués</div>
      </div>
    </div>

    <div class="topchips">
      <span class="chip">Fiche #{{ fiche.numero }}</span>
      <span class="chip">{{ fiche.nom }} {{ fiche.prenom }}</span>
      <span class="chip">
        {% if fiche.statut == 'présent' %}Présent
        {% elif fiche.statut == 'sorti' %}Sorti
        {% else %}Supprimé{% endif %}
      </span>
      {% if fiche.est_animal %}
        <span class="chip chip-animal">🐾 Animal</span>
      {% endif %}
    </div>

    <!-- ✅ Actions très visibles dans le header -->
    <div class="top-actions">
      <a class="btn secondary" href="{{ url_for('main_bp.dashboard', evenement_id=fiche.evenement.id) }}">
        ← Retour au dashboard
      </a>
      <!-- 👉 Nouveau bouton Modifier (header) -->
      <a class="btn secondary" href="{{ url_for('main_bp.fiche_edit', id=fiche.id) }}">
        ✏️ Modifier la fiche
      </a>
      <a class="btn primary" href="{{ url_for('main_bp.export_pdf_fiche', id=fiche.id) }}">
        📄 Exporter PDF
      </a>
    </div>
  </div>
</header>

<main class="wrapper">

  <!-- ===== Hero fiche ===== -->
  <section class="hero">
    <h1>Fiche impliqué</h1>
    <div class="meta">
      {% if fiche.statut == 'présent' %}
        <span class="pill p-ok">Statut : Présent</span>
      {% elif fiche.statut == 'sorti' %}
        <span class="pill p-warn">Statut : Sorti</span>
      {% else %}
        <span class="pill p-err">Statut : Supprimé</span>
      {% endif %}
      <span class="pill">Évènement : {{ fiche.evenement.nom }}</span>
      {% if fiche.est_animal %}
        <span class="pill">Type : Animal</span>
      {% endif %}
    </div>

    <div class="timebar">
      <div class="timegroup">
        <div class="lbl">Heure d’arrivée</div>
        <div class="val">
          {% if fiche.heure_arrivee_locale %}
            {{ fiche.heure_arrivee_locale.strftime('%d/%m/%Y %H:%M') }}
          {% else %}—{% endif %}
        </div>
      </div>
      <div class="bar" aria-hidden="true"></div>
      <div class="timegroup" style="text-align:right;">
        <div class="lbl">Heure de sortie</div>
        <div class="val">
          {% if fiche.heure_sortie_locale %}
            {{ fiche.heure_sortie_locale.strftime('%d/%m/%Y %H:%M') }}
          {% else %}—{% endif %}
        </div>
      </div>
    </div>

    <div class="tiles">
      {% if fiche.est_animal %}
        <div class="tile">
          <div class="ico">🐾</div>
          <div>
            <div class="k">Nom</div>
            <div class="v">{{ fiche.nom or '—' }}</div>
          </div>
        </div>
        <div class="tile">
          <div class="ico">🦴</div>
          <div>
            <div class="k">Espèce</div>
            <div class="v">{{ fiche.animal_espece or 'Non renseignée' }}</div>
          </div>
        </div>
        <div class="tile">
          <div class="ico">🧍</div>
          <div>
            <div class="k">Personne référente</div>
            <div class="v">
              {% if fiche.referent_humain %}
                <a href="{{ url_for('main_bp.fiche_detail', id=fiche.referent_humain.id) }}" class="link-inline">
                  {{ fiche.referent_humain.prenom }} {{ fiche.referent_humain.nom }}
                </a>
              {% else %}
                Aucune
              {% endif %}
            </div>
          </div>
        </div>
        <div class="tile">
          <div class="ico">📝</div>
          <div>
            <div class="k">Notes</div>
            <div class="v">{{ fiche.animal_details or '—' }}</div>
          </div>
        </div>
      {% else %}
        <div class="tile">
          <div class="ico">🎂</div>
          <div>
            <div class="k">Naissance</div>
            <div class="v">
              {% if fiche.date_naissance %}
                {{ fiche.date_naissance.strftime('%d/%m/%Y') }}
                {% set age_val = fiche.date_naissance|age %}
                {% if age_val is not none %}
                  <span class="age-badge" aria-label="Âge estimé">{{ age_val }} ans</span>
                {% endif %}
              {% else %}
                —
              {% endif %}
            </div>
          </div>
        </div>
        <div class="tile">
          <div class="ico">🏷️</div>
          <div><div class="k">Code Sinus</div><div class="v">{{ fiche.code_sinus or '—' }}</div></div>
        </div>
        <div class="tile">
          <div class="ico">📞</div>
          <div><div class="k">Téléphone</div><div class="v">{{ fiche.telephone or '—' }}</div></div>
        </div>
        <div class="tile">
          <div class="ico">📄</div>
          <div><div class="k">Fiche Argos/AEP</div><div class="v">{{ fiche.numero_pec or '—' }}</div></div>
        </div>
      {% endif %}
    </div>
  </section>

  <!-- ===== Grille principale ===== -->
  <section class="grid">

    <!-- Infos personnelles -->
    <article class="card">
      <div class="hd">Informations personnelles</div>
      <div class="bd">
        <div class="fields">
          {% if fiche.est_animal %}
            <div class="field"><div class="label">Nom</div><div class="value">{{ fiche.nom or '—' }}</div></div>
            <div class="field"><div class="label">Espèce</div><div class="value">{{ fiche.animal_espece or 'Non renseignée' }}</div></div>
            <div class="field"><div class="label">Personne référente</div>
              <div class="value">
                {% if fiche.referent_humain %}
                  <a href="{{ url_for('main_bp.fiche_detail', id=fiche.referent_humain.id) }}" class="link-inline">{{ fiche.referent_humain.prenom }} {{ fiche.referent_humain.nom }}</a>
                {% else %}Aucune{% endif %}
              </div>
            </div>
            <div class="field"><div class="label">Évènement</div><div class="value">{{ fiche.evenement.nom }}</div></div>
          {% else %}
            <div class="field"><div class="label">Nom</div><div class="value">{{ fiche.nom }}</div></div>
            <div class="field"><div class="label">Prénom</div><div class="value">{{ fiche.prenom }}</div></div>
            <div class="field">
              <div class="label">Date de naissance</div>
              <div class="value">
                {% if fiche.date_naissance %}
                  {{ fiche.date_naissance.strftime('%d/%m/%Y') }}
                  {% set age_field = fiche.date_naissance|age %}
                  {% if age_field is not none %}
                    <span class="age-badge">{{ age_field }} ans</span>
                  {% endif %}
                {% else %}
                  Non renseignée
                {% endif %}
              </div>
            </div>
            <div class="field"><div class="label">Code Sinus</div><div class="value">{{ fiche.code_sinus or 'Non renseigné' }}</div></div>
            <div class="field full"><div class="label">Adresse</div><div class="value">{{ fiche.adresse or 'Non renseignée' }}</div></div>
            <div class="field"><div class="label">Téléphone</div><div class="value">{{ fiche.telephone or 'Non renseigné' }}</div></div>
            <div class="field"><div class="label">Évènement</div><div class="value">{{ fiche.evenement.nom }}</div></div>
          {% endif %}
        </div>

        <!-- Boutons secondaires (doublon, au cas où) -->
        <div class="actions">
          <a class="btn secondary" href="{{ url_for('main_bp.dashboard', evenement_id=fiche.evenement.id) }}">← Retour au dashboard</a>
          <!-- 👉 Nouveau bouton Modifier (section infos) -->
          <a class="btn secondary" href="{{ url_for('main_bp.fiche_edit', id=fiche.id) }}">✏️ Modifier la fiche</a>
          <a class="btn primary" href="{{ url_for('main_bp.export_pdf_fiche', id=fiche.id) }}">📄 Exporter PDF</a>
        </div>
      </div>
    </article>

    <!-- Statut & infos -->
    <article class="card">
      <div class="hd">Statut & informations</div>
      <div class="bd">
        <div class="fields">
          <div class="field">
            <div class="label">Statut</div>
            <div class="value">
              {% if fiche.statut == 'présent' %}
                <span class="tag">🟢 Présent</span>
              {% elif fiche.statut == 'sorti' %}
                <span class="tag">🟡 Sorti</span>
              {% else %}
                <span class="tag">🔴 Supprimé</span>
              {% endif %}
            </div>
          </div>

          {% if fiche.est_animal %}
            <div class="field full"><div class="label">Particularités</div><div class="value">{{ fiche.difficultes or 'Non renseignée' }}</div></div>
            <div class="field full"><div class="label">Notes complémentaires</div><div class="value">{{ fiche.animal_details or 'Non renseigné' }}</div></div>
          {% else %}
            <div class="field">
              <div class="label">Personne à prévenir</div>
              <div class="value">
                {% if fiche.personne_a_prevenir %}
                  {{ fiche.personne_a_prevenir }}{% if fiche.tel_personne_a_prevenir %} — {{ fiche.tel_personne_a_prevenir }}{% endif %}
                {% else %}Non renseigné{% endif %}
              </div>
            </div>

            <div class="field full"><div class="label">Difficultés</div><div class="value">{{ fiche.difficultes or 'Non renseignée' }}</div></div>
            <div class="field full"><div class="label">Autres informations</div><div class="value">{{ fiche.autres_informations or 'Non renseigné' }}</div></div>

            <div class="field"><div class="label">Destination</div><div class="value">{{ fiche.destination or 'Non renseignée' }}</div></div>
            <div class="field"><div class="label">Moyen de transport</div><div class="value">{{ fiche.moyen_transport or 'Non renseigné' }}</div></div>
            <div class="field"><div class="label">Recherche une personne</div><div class="value">{{ fiche.recherche_personne or 'Non' }}</div></div>

            <div class="field full">
              <div class="label">Compétences</div>
              <div class="value">
                {% set comps = (fiche.competences or '').split(',') if fiche.competences else [] %}
                {% if comps %}
                  <div class="badges">
                    {% for c in comps %}
                      <span class="tag">🏅 {{ c.strip() }}</span>
                    {% endfor %}
                  </div>
                {% else %}Non renseignée{% endif %}
              </div>
            </div>
          {% endif %}

          <div class="field full">
            <div class="label">Bagages</div>
            <div class="value">
              {% if fiche.bagages and fiche.bagages|length > 0 %}
                <div class="badges">
                  {% for bag in fiche.bagages %}
                    <span class="tag">🎒 {{ bag.numero }}</span>
                  {% endfor %}
                </div>
              {% else %}Aucun{% endif %}
            </div>
          </div>
        </div>
      </div>
    </article>

    {% if not fiche.est_animal %}
      {% set animaux = fiche.animaux_rattaches | list %}
      {% if animaux %}
        <article class="card">
          <div class="hd">Animaux rattachés</div>
          <div class="bd">
            <ul class="animal-list">
              {% for animal in animaux %}
                <li>
                  <span class="animal-list__icon" aria-hidden="true">🐾</span>
                  <div class="animal-list__body">
                    <a href="{{ url_for('main_bp.fiche_detail', id=animal.id) }}" class="animal-list__name">{{ animal.nom or 'Animal sans nom' }}</a>
                    <span class="animal-list__meta">{{ animal.animal_espece or 'Espèce inconnue' }} • {{ animal.statut or '—' }}</span>
                  </div>
                </li>
              {% endfor %}
            </ul>
          </div>
        </article>
      {% endif %}
    {% endif %}

  </section>

  <!-- ===== Timeline ===== -->
  <section class="card timeline">
    <div class="hd">Suivi / Timeline</div>
    <div class="bd">
      <div class="tform-wrap">
        <form class="tform" method="post" action="{{ url_for('main_bp.add_timeline_comment', fiche_id=fiche.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <textarea name="content" id="tl-content" placeholder="Ajouter un commentaire de suivi..."></textarea>
          <!-- miroir pour compat si la route lit 'comment' -->
          <input type="hidden" name="comment" id="tl-comment">
          <button type="submit">+ Ajouter</button>
        </form>
      </div>

      {% if not entries %}
        <p class="tmeta" style="margin:6px 2px; color:var(--muted);">Aucun commentaire pour l'instant.</p>
      {% else %}
        <div class="tline">
          {% for e in entries %}
            <div class="titem" id="entry-{{ e.id }}">
              <div class="ttime">{{ e.created_at|fr_datetime }}</div>
              <div class="tcontent">{{ (e.content or e.message)|e }}</div>
              <div class="tmeta">par {{ e.user.nom if e.user else ('#' ~ e.user_id) }}</div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </section>

</main>

<script>
/* miroir content->comment pour compat route */
(function(){
  const t = document.getElementById('tl-content');
  const h = document.getElementById('tl-comment');
  if(t && h){ const sync = () => { h.value = t.value; }; t.addEventListener('input', sync); sync(); }
})();
</script>

</body>
</html>
