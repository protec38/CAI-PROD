{% extends "base.html" %}
{% block content %}


<div class="fd-wrap">

  <!-- ===== HERO ===== -->
  <div class="fd-hero">
    <h2>D√©tail de la fiche impliqu√©</h2>
    <div class="meta">
      <span class="chip"><i class="fa-solid fa-hashtag"></i> {{ fiche.numero }}</span>
      <span class="chip"><i class="fa-solid fa-user"></i> {{ fiche.nom }} {{ fiche.prenom }}</span>
      <span class="chip">
        {% if fiche.statut == 'pr√©sent' %}<i class="fa-solid fa-circle-check"></i>
        {% elif fiche.statut == 'sorti' %}<i class="fa-solid fa-person-walking-arrow-right"></i>
        {% else %}<i class="fa-solid fa-trash-can"></i>{% endif %}
        {{ fiche.statut|capitalize }}
      </span>
    </div>

    <!-- Tuiles de r√©sum√© -->
    <div class="fd-tiles">
      <div class="tile">
        <div class="ico"><i class="fa-solid fa-cake-candles"></i></div>
        <div>
          <div class="k">Naissance</div>
          <div class="v">{{ fiche.date_naissance.strftime('%d/%m/%Y') if fiche.date_naissance else '‚Äî' }}</div>
        </div>
      </div>
      <div class="tile">
        <div class="ico"><i class="fa-solid fa-barcode"></i></div>
        <div>
          <div class="k">Code Sinus</div>
          <div class="v">{{ fiche.code_sinus or '‚Äî' }}</div>
        </div>
      </div>
      <div class="tile">
        <div class="ico"><i class="fa-solid fa-phone"></i></div>
        <div>
          <div class="k">T√©l√©phone</div>
          <div class="v">{{ fiche.telephone or '‚Äî' }}</div>
        </div>
      </div>
      <div class="tile">
        <div class="ico"><i class="fa-solid fa-shield-halved"></i></div>
        <div>
          <div class="k">√âv√®nement</div>
          <div class="v">{{ fiche.evenement.nom }}</div>
        </div>
      </div>
    </div>

    <!-- Timeline Arriv√©e / Sortie -->
    <div class="timeline">
      <div style="display:flex; align-items:center; gap:10px;">
        <span class="dot"><i class="fa-solid fa-arrow-down"></i></span>
        <div>
          <div class="lbl">Arriv√©e</div>
          <div class="val">{{ fiche.heure_arrivee_locale.strftime('%d/%m/%Y %H:%M') if fiche.heure_arrivee_locale else '‚Äî' }}</div>
        </div>
      </div>
      <div class="sep"></div>
      <div style="display:flex; align-items:center; gap:10px;">
        <div style="text-align:right">
          <div class="lbl">Sortie</div>
          <div class="val">{{ fiche.heure_sortie_locale.strftime('%d/%m/%Y %H:%M') if fiche.heure_sortie_locale else '‚Äî' }}</div>
        </div>
        <span class="dot"><i class="fa-solid fa-arrow-up"></i></span>
      </div>
    </div>
  </div>

  <!-- ===== CONTENU ===== -->
  <div class="fd-grid">

    <!-- Colonne gauche : Informations personnelles -->
    <div class="fd-card fd-section">
      <h4><i class="fa-solid fa-id-card-clip"></i> Informations personnelles</h4>
      <div class="fd-list">
        <div class="fd-item">
          <span class="lbl">Nom</span>
          <span class="val">{{ fiche.nom }}</span>
        </div>
        <div class="fd-item">
          <span class="lbl">Pr√©nom</span>
          <span class="val">{{ fiche.prenom }}</span>
        </div>
        <div class="fd-item">
          <span class="lbl">Date de naissance</span>
          <span class="val">{{ fiche.date_naissance.strftime('%d/%m/%Y') if fiche.date_naissance else 'Non renseign√©e' }}</span>
        </div>
        <div class="fd-item">
          <span class="lbl">Code Sinus</span>
          <span class="val">{{ fiche.code_sinus or 'Non renseign√©' }}</span>
        </div>

        <!-- üÜï N¬∞ prise en charge (Argos/AEP) -->
        <div class="fd-item">
          <span class="lbl">N¬∞ prise en charge (Argos/AEP)</span>
          <span class="val">{{ fiche.numero_pec or 'Non renseign√©' }}</span>
        </div>

        <div class="fd-item" style="grid-column: span 2;">
          <span class="lbl">Adresse</span>
          <span class="val">{{ fiche.adresse or 'Non renseign√©e' }}</span>
        </div>
        <div class="fd-item">
          <span class="lbl">T√©l√©phone</span>
          <span class="val">{{ fiche.telephone or 'Non renseign√©' }}</span>
        </div>
        <div class="fd-item">
          <span class="lbl">√âv√®nement</span>
          <span class="val">{{ fiche.evenement.nom }}</span>
        </div>
      </div>
    </div>

    <!-- Colonne droite : Statut & infos -->
    <div class="fd-card fd-section">
      <h4><i class="fa-solid fa-circle-info"></i> Statut & informations</h4>

      <div class="fd-list">
        <div class="fd-item">
          <span class="lbl">Statut</span>
          <span class="val">
            {% if fiche.statut == 'pr√©sent' %}
              <span class="statut-pill statut-present"><i class="fa-solid fa-circle-check"></i> Pr√©sent</span>
            {% elif fiche.statut == 'sorti' %}
              <span class="statut-pill statut-sorti"><i class="fa-solid fa-person-walking-arrow-right"></i> Sorti</span>
            {% else %}
              <span class="statut-pill statut-supprime"><i class="fa-solid fa-trash-can"></i> Supprim√©</span>
            {% endif %}
          </span>
        </div>

        <div class="fd-item">
          <span class="lbl">Personne √† pr√©venir</span>
          <span class="val">
            {% if fiche.personne_a_prevenir %}
              {{ fiche.personne_a_prevenir }}{% if fiche.tel_personne_a_prevenir %} ‚Äì {{ fiche.tel_personne_a_prevenir }}{% endif %}
            {% else %}Non renseign√©{% endif %}
          </span>
        </div>

        <div class="fd-item" style="grid-column: span 2;">
          <span class="lbl">Difficult√©s</span>
          <span class="val">{{ fiche.difficultes or 'Non renseign√©e' }}</span>
        </div>

        <div class="fd-item" style="grid-column: span 2;">
          <span class="lbl">Autres informations</span>
          <span class="val">{{ fiche.autres_informations or 'Non renseign√©' }}</span>
        </div>

        <div class="fd-item">
          <span class="lbl">Destination</span>
          <span class="val">{{ fiche.destination or 'Non renseign√©e' }}</span>
        </div>

        <div class="fd-item">
          <span class="lbl">Moyen de transport</span>
          <span class="val">{{ fiche.moyen_transport or 'Non renseign√©' }}</span>
        </div>

        <div class="fd-item">
          <span class="lbl">Recherche une personne</span>
          <span class="val">{{ fiche.recherche_personne or 'Non' }}</span>
        </div>

        <div class="fd-item" style="grid-column: span 2;">
          <span class="lbl">Comp√©tences</span>
          {% set comps = (fiche.competences or '').split(',') if fiche.competences else [] %}
          {% if comps %}
            <div class="fd-badges">
              {% for c in comps %}
                {% set t = c.strip() %}
                {% set cls =
                  'medecin' if t=='M√©decin'
                  else 'infirmier' if t=='Infirmier'
                  else 'pompier' if t=='Sapeur-pompier'
                  else 'sst' if t=='SST'
                  else 'psy' if t=='Psychologue'
                  else 'benevole' if t=='B√©n√©vole'
                  else 'artisan' if t=='Artisan'
                  else 'interprete' if t=='Interpr√®te'
                  else 'logisticien' if t=='Logisticien'
                  else 'conducteur' if t=='Conducteur'
                  else 'securite' if t=='Agent s√©curit√©'
                  else 'autre' %}
                <span class="badge-competence {{ cls }}"><i class="fa-solid fa-award"></i> {{ t }}</span>
              {% endfor %}
            </div>
          {% else %}
            <span class="val">Non renseign√©e</span>
          {% endif %}
        </div>

        <div class="fd-item" style="grid-column: span 2;">
          <span class="lbl">Bagages</span>
          {% if fiche.bagages and fiche.bagages|length > 0 %}
            <div class="fd-badges">
              {% for bag in fiche.bagages %}
                <span class="badge-bagage"><i class="fa-solid fa-suitcase-rolling"></i> {{ bag.numero }}</span>
              {% endfor %}
            </div>
          {% else %}
            <span class="val">Aucun</span>
          {% endif %}
        </div>
      </div>
    </div>

  </div>

  <!-- ===== Actions ===== -->
  <div class="fd-actions">
    <a href="{{ url_for('main_bp.dashboard', evenement_id=fiche.evenement.id) }}" class="btn-soft btn-secondary">
      <i class="fa-solid fa-arrow-left-long"></i> Retour au dashboard
    </a>
    <a href="{{ url_for('main_bp.export_pdf_fiche', id=fiche.id) }}" class="btn-soft btn-warning">
      <i class="fa-solid fa-file-pdf"></i> Exporter en PDF
    </a>
  </div>
</div>

<section id="timeline" class="card" style="margin-top:16px;">
  <h2>Suivi / Timeline</h2>
  <form method="post" action="{{ url_for('main_bp.add_timeline_comment', fiche_id=fiche.id) }}" class="row">
    <textarea name="comment" rows="3" placeholder="Ajouter un commentaire de suivi..." style="flex:1; width:100%;"></textarea>
    <button class="btn" type="submit">Ajouter</button>
  </form>
  <div class="timeline-list">
    
    {% if not entries %}
      <p class="muted">Aucun commentaire pour l'instant.</p>
    {% else %}
      <ul class="timeline-ul">
        {% for e in entries %}
          <li class="timeline-item">
            <div class="timeline-time">{{ e.created_at|fr_datetime }}</div>
            <div class="timeline-content">{{ e.content|e }}</div>
            <div class="timeline-meta">par #{{ e.user_id }}</div>
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>
</section>

{% endblock %}
