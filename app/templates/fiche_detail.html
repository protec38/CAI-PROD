{% extends "base.html" %}
{% block content %}

<style>
  /* ========= Thème Protection Civile — Futuriste ========= */
  :root{
    --pc-blue:#003b71;
    --pc-blue-2:#0a2f57;
    --pc-orange:#f58220;
    --pc-amber:#ffcc00;
    --bg:#0f172a;               /* fond profond */
    --bg-2:#0b1d38;
    --glass:rgba(255,255,255,.09);
    --glass-2:rgba(255,255,255,.12);
    --line:rgba(255,255,255,.18);
    --ink:#eaf2ff;              /* texte principal clair */
    --muted:#b9c6dd;            /* texte secondaire */
    --success:#18a079;
    --warn:#c77600;
    --danger:#e35151;
    --radius:18px;
    --gap:18px;
    --shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
  }

  /* ===== Anti-navbar (si fixe) */
  .page{ padding-top: 80px; }

  /* ===== Arrière-plan héro plein écran */
  body{
    background:
      radial-gradient(1200px 600px at 10% -10%, #113869 0%, transparent 60%),
      radial-gradient(900px 500px at 100% 0%, #193a6a 0%, transparent 60%),
      linear-gradient(180deg, var(--bg) 0%, #081528 100%);
  }

  /* ===== Contrainte & respirations */
  .wrap{
    width: min(1800px, 96vw);
    margin: 0 auto 40px;
  }

  /* ===== HERO ===== */
  .hero{
    position: relative;
    border-radius: calc(var(--radius) + 6px);
    padding: 22px clamp(16px, 3vw, 28px);
    color: var(--ink);
    background:
      linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)),
      linear-gradient(95deg, rgba(255,255,255,.06), rgba(255,255,255,0));
    border:1px solid var(--line);
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  .hero:before{
    content:"";
    position:absolute; inset:-2px;
    background:
      radial-gradient(600px 140px at 20% 0%, rgba(245,130,32,.35), transparent 60%),
      radial-gradient(800px 200px at 90% -10%, rgba(0,59,113,.40), transparent 60%);
    filter: blur(30px);
    pointer-events:none;
  }
  .hero-head{ position:relative; display:flex; gap:18px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .h-left{ display:flex; gap:14px; align-items:center; }
  .badge-logo{
    width:44px; height:44px; border-radius:14px;
    background: linear-gradient(135deg, var(--pc-orange), #ff9f49);
    color:#1f2b44; display:grid; place-items:center; font-weight:900; box-shadow: inset 0 2px 10px rgba(0,0,0,.15);
  }
  .title{ margin:0; line-height:1.15; font-size: clamp(22px, 3vw, 36px); letter-spacing: .5px; }
  .sub{ color: var(--muted); font-weight:600; }

  .chips{ display:flex; flex-wrap:wrap; gap:10px; }
  .chip{
    color:var(--ink);
    display:inline-flex; align-items:center; gap:10px;
    padding:10px 14px; border-radius:999px;
    border:1px solid var(--line);
    background: linear-gradient(180deg, var(--glass-2), var(--glass));
    backdrop-filter: blur(8px);
    box-shadow: var(--shadow);
    font-weight:800;
  }

  /* ===== RECAP TILES ===== */
  .tiles{
    position:relative; z-index:2;
    display:grid; gap:16px; margin-top:16px;
    grid-template-columns: repeat(4, minmax(220px, 1fr));
  }
  .tile{
    border:1px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    backdrop-filter: blur(8px);
    border-radius: 16px; padding:14px; color:var(--ink);
    display:flex; gap:12px; align-items:center; box-shadow: var(--shadow);
  }
  .ico{ width:36px; height:36px; border-radius:12px; display:grid; place-items:center;
        background: linear-gradient(135deg, #173a6a, #0d2749); color:#fff; border:1px solid var(--line); }
  .tile .k{ font-size:.85rem; color:var(--muted); font-weight:700; }
  .tile .v{ font-weight:900; font-size:1.05rem; }

  /* ===== MAIN GRID ===== */
  .main-grid{
    margin-top: 22px;
    display:grid; gap:22px;
    grid-template-columns: 1fr 1fr 0.9fr;        /* 3 colonnes si possible */
  }

  /* Panneaux verre */
  .panel{
    border:1px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
    backdrop-filter: blur(8px);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    color:var(--ink);
    overflow:hidden;
  }
  .panel .ph{
    display:flex; align-items:center; gap:12px;
    padding:14px 18px;
    border-bottom:1px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
    font-weight:900; letter-spacing:.3px; color:#eaf2ff;
  }
  .panel .pb{ padding:18px; }

  /* ===== Fields en cartes (label au-dessus) ===== */
  .fields{
    display:grid; gap:14px;
    grid-template-columns: repeat(2, minmax(260px, 1fr));
  }
  .field{
    border:1px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
    border-radius:14px; padding:14px;
  }
  .flabel{ color:var(--muted); font-weight:800; font-size:.85rem; letter-spacing:.04em; margin-bottom:6px; text-transform: uppercase; }
  .fvalue{ color:var(--ink); font-weight:900; font-size:1.05rem; line-height:1.45; word-break:break-word; }

  /* tags/pills */
  .badges{ display:flex; gap:10px; flex-wrap:wrap; }
  .tag{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border-radius:999px; border:1px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    font-weight:800; color:var(--ink);
  }
  .pill{ border:1px solid var(--line); padding:8px 12px; border-radius:999px; font-weight:900; }
  .pill.present{ background: linear-gradient(180deg, rgba(24,160,121,.25), rgba(24,160,121,.12)); color:#bdf4e6; }
  .pill.sorti{ background: linear-gradient(180deg, rgba(255,204,0,.25), rgba(255,204,0,.12)); color:#ffe9a6; }
  .pill.supprime{ background: linear-gradient(180deg, rgba(227,81,81,.28), rgba(227,81,81,.12)); color:#ffd1d1; }

  /* ===== Actions ===== */
  .actions{ display:flex; flex-wrap:wrap; gap:12px; margin-top:16px; }
  .btn{
    display:inline-flex; align-items:center; gap:10px; padding:12px 16px; border-radius:12px;
    font-weight:900; text-decoration:none; border:1px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
    color:var(--ink); box-shadow: var(--shadow);
  }
  .btn:hover{ filter: brightness(1.08); }
  .btn-warning{ background: linear-gradient(180deg, rgba(245,130,32,.28), rgba(245,130,32,.12)); }

  /* ===== Timeline ===== */
  .timeline .pb{ display:grid; gap:14px; }
  .tform{ display:flex; gap:12px; align-items:flex-start; }
  .tform textarea{
    flex:1; min-height:120px; resize:vertical; padding:12px;
    border-radius:12px; border:1px solid var(--line);
    background: rgba(255,255,255,.06); color:var(--ink);
  }
  .tlist{ display:flex; flex-direction:column; gap:12px; }
  .titem{
    border:1px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
    border-radius:14px; padding:12px 14px;
  }
  .ttime{ color:var(--muted); font-size:.95rem; margin-bottom:6px; }
  .tcontent{ white-space:pre-wrap; color:var(--ink); font-weight:800; }
  .tmeta{ margin-top:6px; color:var(--muted); font-size:.9rem; }

  /* ===== Responsive ===== */
  @media (max-width: 1500px){
    .tiles{ grid-template-columns: repeat(3, minmax(220px, 1fr)); }
    .main-grid{ grid-template-columns: 1fr 1fr; }
  }
  @media (max-width: 980px){
    .tiles{ grid-template-columns: repeat(2, minmax(220px, 1fr)); }
    .fields{ grid-template-columns: 1fr; }
    .main-grid{ grid-template-columns: 1fr; }
    .page{ padding-top: 72px; }
  }
</style>

<div class="page">
  <div class="wrap">

    <!-- ================= HERO ================= -->
    <section class="hero">
      <div class="hero-head">
        <div class="h-left">
          <div class="badge-logo"><i class="fa-solid fa-shield-halved"></i></div>
          <div>
            <h1 class="title">Fiche impliqué</h1>
            <div class="sub">Centre d’Accueil des Impliqués — Protection Civile</div>
          </div>
        </div>
        <div class="chips">
          <span class="chip"><i class="fa-solid fa-hashtag"></i> {{ fiche.numero }}</span>
          <span class="chip"><i class="fa-solid fa-user"></i> {{ fiche.nom }} {{ fiche.prenom }}</span>
          <span class="chip">
            {% if fiche.statut == 'présent' %}
              <i class="fa-solid fa-circle-check"></i> Présent
            {% elif fiche.statut == 'sorti' %}
              <i class="fa-solid fa-person-walking-arrow-right"></i> Sorti
            {% else %}
              <i class="fa-solid fa-trash-can"></i> Supprimé
            {% endif %}
          </span>
        </div>
      </div>

      <!-- Tuiles récap -->
      <div class="tiles">
        <div class="tile">
          <div class="ico"><i class="fa-solid fa-cake-candles"></i></div>
          <div><div class="k">Naissance</div><div class="v">{{ fiche.date_naissance.strftime('%d/%m/%Y') if fiche.date_naissance else '—' }}</div></div>
        </div>
        <div class="tile">
          <div class="ico"><i class="fa-solid fa-barcode"></i></div>
          <div><div class="k">Code Sinus</div><div class="v">{{ fiche.code_sinus or '—' }}</div></div>
        </div>
        <div class="tile">
          <div class="ico"><i class="fa-solid fa-phone"></i></div>
          <div><div class="k">Téléphone</div><div class="v">{{ fiche.telephone or '—' }}</div></div>
        </div>
        <div class="tile">
          <div class="ico"><i class="fa-solid fa-building-shield"></i></div>
          <div><div class="k">Évènement</div><div class="v">{{ fiche.evenement.nom }}</div></div>
        </div>
      </div>
    </section>

    <!-- ================= CONTENU ================= -->
    <section class="main-grid">

      <!-- Panneau: Informations personnelles -->
      <article class="panel">
        <div class="ph"><i class="fa-solid fa-id-card-clip"></i> Informations personnelles</div>
        <div class="pb">
          <div class="fields">
            <div class="field"><div class="flabel">Nom</div><div class="fvalue">{{ fiche.nom }}</div></div>
            <div class="field"><div class="flabel">Prénom</div><div class="fvalue">{{ fiche.prenom }}</div></div>
            <div class="field"><div class="flabel">Date de naissance</div><div class="fvalue">{{ fiche.date_naissance.strftime('%d/%m/%Y') if fiche.date_naissance else 'Non renseignée' }}</div></div>
            <div class="field"><div class="flabel">Code Sinus</div><div class="fvalue">{{ fiche.code_sinus or 'Non renseigné' }}</div></div>
            <div class="field"><div class="flabel">N° prise en charge (Argos/AEP)</div><div class="fvalue">{{ fiche.numero_pec or 'Non renseigné' }}</div></div>
            <div class="field" style="grid-column:1 / -1;"><div class="flabel">Adresse</div><div class="fvalue">{{ fiche.adresse or 'Non renseignée' }}</div></div>
            <div class="field"><div class="flabel">Téléphone</div><div class="fvalue">{{ fiche.telephone or 'Non renseigné' }}</div></div>
            <div class="field"><div class="flabel">Évènement</div><div class="fvalue">{{ fiche.evenement.nom }}</div></div>
          </div>

          <div class="actions">
            <a href="{{ url_for('main_bp.dashboard', evenement_id=fiche.evenement.id) }}" class="btn">
              <i class="fa-solid fa-arrow-left-long"></i> Retour au dashboard
            </a>
            <a href="{{ url_for('main_bp.export_pdf_fiche', id=fiche.id) }}" class="btn btn-warning">
              <i class="fa-solid fa-file-pdf"></i> Exporter en PDF
            </a>
          </div>
        </div>
      </article>

      <!-- Panneau: Statut & infos -->
      <article class="panel">
        <div class="ph"><i class="fa-solid fa-circle-info"></i> Statut & informations</div>
        <div class="pb">
          <div class="fields">
            <div class="field">
              <div class="flabel">Statut</div>
              <div class="fvalue">
                {% if fiche.statut == 'présent' %}
                  <span class="pill present"><i class="fa-solid fa-circle-check"></i> Présent</span>
                {% elif fiche.statut == 'sorti' %}
                  <span class="pill sorti"><i class="fa-solid fa-person-walking-arrow-right"></i> Sorti</span>
                {% else %}
                  <span class="pill supprime"><i class="fa-solid fa-trash-can"></i> Supprimé</span>
                {% endif %}
              </div>
            </div>

            <div class="field">
              <div class="flabel">Personne à prévenir</div>
              <div class="fvalue">
                {% if fiche.personne_a_prevenir %}
                  {{ fiche.personne_a_prevenir }}{% if fiche.tel_personne_a_prevenir %} – {{ fiche.tel_personne_a_prevenir }}{% endif %}
                {% else %}Non renseigné{% endif %}
              </div>
            </div>

            <div class="field" style="grid-column:1 / -1;">
              <div class="flabel">Difficultés</div>
              <div class="fvalue">{{ fiche.difficultes or 'Non renseignée' }}</div>
            </div>

            <div class="field" style="grid-column:1 / -1;">
              <div class="flabel">Autres informations</div>
              <div class="fvalue">{{ fiche.autres_informations or 'Non renseigné' }}</div>
            </div>

            <div class="field"><div class="flabel">Destination</div><div class="fvalue">{{ fiche.destination or 'Non renseignée' }}</div></div>
            <div class="field"><div class="flabel">Moyen de transport</div><div class="fvalue">{{ fiche.moyen_transport or 'Non renseigné' }}</div></div>
            <div class="field"><div class="flabel">Recherche une personne</div><div class="fvalue">{{ fiche.recherche_personne or 'Non' }}</div></div>

            <div class="field" style="grid-column:1 / -1;">
              <div class="flabel">Compétences</div>
              <div class="fvalue">
                {% set comps = (fiche.competences or '').split(',') if fiche.competences else [] %}
                {% if comps %}
                  <div class="badges">
                    {% for c in comps %}
                      <span class="tag"><i class="fa-solid fa-award"></i> {{ c.strip() }}</span>
                    {% endfor %}
                  </div>
                {% else %}Non renseignée{% endif %}
              </div>
            </div>

            <div class="field" style="grid-column:1 / -1;">
              <div class="flabel">Bagages</div>
              <div class="fvalue">
                {% if fiche.bagages and fiche.bagages|length > 0 %}
                  <div class="badges">
                    {% for bag in fiche.bagages %}
                      <span class="tag"><i class="fa-solid fa-suitcase-rolling"></i> {{ bag.numero }}</span>
                    {% endfor %}
                  </div>
                {% else %}Aucun{% endif %}
              </div>
            </div>
          </div>
        </div>
      </article>

      <!-- Panneau: Timeline (sur large écran à droite, sinon en bas) -->
      <article class="panel timeline">
        <div class="ph"><i class="fa-solid fa-clock-rotate-left"></i> Suivi / Timeline</div>
        <div class="pb">
          <form method="post" action="{{ url_for('main_bp.add_timeline_comment', fiche_id=fiche.id) }}" class="tform">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <textarea name="content" placeholder="Ajouter un commentaire de suivi..."></textarea>
            <button class="btn" type="submit"><i class="fa-solid fa-plus"></i> Ajouter</button>
          </form>

          {% if not entries %}
            <p class="tmeta">Aucun commentaire pour l'instant.</p>
          {% else %}
            <div class="tlist">
              {% for e in entries %}
                <div class="titem" id="entry-{{ e.id }}">
                  <div class="ttime">{{ e.created_at|fr_datetime }}</div>
                  <div class="tcontent">{{ (e.content or e.message)|e }}</div>
                  <div class="tmeta">par #{{ e.user_id }}</div>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </article>

    </section>

  </div>
</div>

{% endblock %}
