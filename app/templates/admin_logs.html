<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>üóíÔ∏è Journal d'audit</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

<style>
  :root{
    --pc-blue:#003b71;
    --pc-blue-dark:#002952;
    --pc-orange:#f58220;
    --pc-amber:#fdb022;
    --bg:#f6f8fc;
    --card:#ffffff;
    --line:#dbe4f3;
    --ink:#0f172a;
    --muted:#667085;
    --radius:16px;
    --shadow:0 10px 24px rgba(16,24,40,.06);
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:15px/1.45 "Segoe UI",system-ui,-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial;min-height:100%}

  header{
    background:linear-gradient(135deg,var(--pc-blue),var(--pc-blue-dark));
    color:#fff;
    padding:22px 16px 26px;
    border-bottom:4px solid var(--pc-orange);
  }
  .header-wrap{width:100%;max-width:none;margin:0 auto;display:flex;gap:18px;align-items:center;flex-wrap:wrap;justify-content:space-between;padding:0 clamp(16px,4vw,48px)}
  .brand{display:flex;align-items:center;gap:14px}
  .brand .logo{width:58px;height:58px;border-radius:16px;display:grid;place-items:center;font-weight:900;background:linear-gradient(135deg,var(--pc-orange),var(--pc-amber));color:#132c4a;box-shadow:inset 0 4px 16px rgba(0,0,0,.18)}
  .brand h1{margin:0;font-size:clamp(22px,3vw,30px);letter-spacing:.3px}
  .brand p{margin:2px 0 0;font-weight:600;opacity:.9}
  .header-actions{display:flex;gap:10px;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:12px;border:1px solid rgba(255,255,255,.45);background:rgba(255,255,255,.15);color:#fff;font-weight:700;text-decoration:none}
  .btn:hover{background:rgba(255,255,255,.25)}

  main{width:100%;max-width:none;margin:24px 0 36px;padding:0 clamp(16px,4vw,48px);display:grid;gap:22px}
  .card{background:var(--card);border-radius:var(--radius);border:1px solid var(--line);box-shadow:var(--shadow);overflow:hidden}
  .card .hd{padding:18px clamp(20px,4vw,40px);border-bottom:1px solid var(--line);display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;background:linear-gradient(180deg,#fff,#f8fbff);color:var(--pc-blue-dark);font-weight:900;letter-spacing:.02em}
  .summary{color:var(--muted);font-size:.95rem;display:flex;flex-direction:column;gap:4px}
  .summary span{display:block}
  .summary .auto-clean{font-size:.85rem;color:#475467;font-weight:600}

  form.filters{padding:18px clamp(20px,4vw,40px);border-bottom:1px solid var(--line);display:grid;gap:14px;background:#fbfdff}
  .filters-row{display:flex;flex-wrap:wrap;gap:12px}
  .field{display:flex;flex-direction:column;min-width:160px;flex:1}
  .field label{font-size:.8rem;letter-spacing:.05em;text-transform:uppercase;color:var(--muted);font-weight:800;margin-bottom:6px}
  .field select,.field input{border:1px solid var(--line);border-radius:12px;padding:10px 12px;font:inherit;background:#fff}
  .field input[type="search"]{min-width:220px}
  .filters-actions{display:flex;gap:10px;flex-wrap:wrap}
  .btn-secondary{background:#eef3ff;border-color:#d7e2ff;color:var(--pc-blue)}
  .btn-outline{background:#fff;border-color:var(--line);color:var(--pc-blue)}
  .chips{display:flex;flex-wrap:wrap;gap:8px;padding:0 clamp(20px,4vw,40px) 16px}
  .chip{background:#eef3ff;border:1px solid #d7e2ff;color:var(--pc-blue);padding:6px 10px;border-radius:999px;font-size:.85rem;font-weight:700;display:inline-flex;align-items:center;gap:8px}

  .table-wrap{overflow-x:auto}
  table{width:100%;border-collapse:collapse;min-width:960px}
  thead th{padding:12px;background:var(--pc-blue);color:#fff;text-align:left;font-size:.85rem;text-transform:uppercase;letter-spacing:.05em}
  tbody td{padding:12px;border-top:1px solid #eef2f7;vertical-align:top}
  tbody tr:nth-child(odd){background:#fbfdff}
  tbody tr:hover{background:#f4f8ff}
  .col-select{text-align:center;width:54px}
  .col-select input{width:18px;height:18px}
  .u-login{font-weight:900}
  .u-id{color:var(--muted);font-size:.9rem;margin-left:.25rem}
  .extra{color:var(--muted);font-size:.85rem}

  .table-actions{padding:16px clamp(20px,4vw,40px);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;border-top:1px solid var(--line);background:#fafcff}
  .table-actions .info{color:var(--muted);font-size:.9rem}
  .table-actions .actions{display:flex;gap:10px;flex-wrap:wrap}
  .btn-danger{background:#fee4e2;border-color:#fca5a5;color:#b42318}
  .btn-danger[disabled]{opacity:.5;cursor:not-allowed}

  .pagination{display:flex;align-items:center;justify-content:center;gap:10px;padding:18px}
  .pagination .btn{background:#eef3ff;color:var(--pc-blue);border-color:#d7e2ff}
  .pagination .muted{color:var(--muted)}

  @media(max-width:760px){
    thead{display:none}
    table,tbody,tr,td{display:block;width:100%}
    tbody tr{margin:12px 0;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    tbody td{border-top:none!important;display:flex;justify-content:space-between;gap:12px;padding:12px 14px}
    tbody td::before{content:attr(data-label);font-weight:800;color:var(--muted);text-transform:uppercase;font-size:.8rem;letter-spacing:.03em}
    .col-select{display:flex;justify-content:flex-start}
  }
</style>
</head>
<body>
  {% include "_flashes.html" %}
  <header>
    <div class="header-wrap">
      <div class="brand">
        <div class="logo">PC</div>
        <div>
          <h1>üóíÔ∏è Journal d'audit</h1>
          <p>Suivi fin des actions sensibles ({{ logs.total }} entr√©es)</p>
        </div>
      </div>
      <div class="header-actions">
        <a class="btn" href="{{ url_for('main_bp.evenement_new') }}"><i class="fa-solid fa-rocket"></i> Portail √©v√®nements</a>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="hd">
        <span>Historique d√©taill√©</span>
        <span class="summary">
          <span>{{ logs.page }} / {{ logs.pages }} ¬∑ {{ per_page }} √©l√©ments par page</span>
          <span class="auto-clean">Purge automatique des entr√©es de plus de 40 jours.</span>
        </span>
      </div>
      <form class="filters" method="get" action="{{ url_for('main_bp.admin_logs') }}">
        <div class="filters-row">
          <div class="field">
            <label for="user_id">Utilisateur</label>
            <select id="user_id" name="user_id">
              <option value="">Tous</option>
              {% for u in users %}
                <option value="{{ u.id }}" {% if filters.user_id == u.id %}selected{% endif %}>{{ u.nom_utilisateur }} (#{{u.id }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="field">
            <label for="action">Action</label>
            <select id="action" name="action">
              <option value="">Toutes</option>
              {% for a in actions %}
                <option value="{{ a }}" {% if filters.action == a %}selected{% endif %}>{{ a }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="field">
            <label for="entity">Objet</label>
            <select id="entity" name="entity">
              <option value="">Tous</option>
              {% for e in entities %}
                <option value="{{ e }}" {% if filters.entity == e %}selected{% endif %}>{{ e }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="field">
            <label for="q">Recherche</label>
            <input id="q" type="search" name="q" placeholder="IP, action, ID‚Ä¶" value="{{ filters.q }}" />
          </div>
          <div class="field" style="max-width:140px">
            <label for="per_page">Par page</label>
            <select id="per_page" name="per_page">
              {% for size in [25,50,100,150,200] %}
                <option value="{{ size }}" {% if per_page == size %}selected{% endif %}>{{ size }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="filters-actions">
          <button class="btn-secondary" type="submit"><i class="fa-solid fa-filter"></i> Appliquer</button>
          <a class="btn-outline" href="{{ url_for('main_bp.admin_logs') }}"><i class="fa-solid fa-rotate"></i> R√©initialiser</a>
        </div>
      </form>
      {% if active_filters %}
      <div class="chips" aria-label="Filtres actifs">
        {% for key, value in active_filters.items() %}
          <span class="chip"><i class="fa-solid fa-tag"></i> {{ key }} : {{ value }}</span>
        {% endfor %}
      </div>
      {% endif %}

      <form method="post" action="{{ url_for('main_bp.admin_logs_delete') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="next" value="{{ request.full_path }}">
        <div class="table-wrap">
          <table id="log-table">
            <thead>
              <tr>
                <th class="col-select"><input type="checkbox" id="check-all"></th>
                <th>Quand</th>
                <th>Utilisateur</th>
                <th>Action</th>
                <th>Objet</th>
                <th>ID</th>
                <th>IP</th>
                <th>D√©tails</th>
              </tr>
            </thead>
            <tbody>
              {% for e in logs.items %}
                <tr>
                  <td class="col-select" data-label="S√©lection"><input type="checkbox" name="log_ids" value="{{ e.id }}" class="row-check"></td>
                  <td data-label="Quand">{{ e.created_at|fr_datetime }}</td>
                  <td data-label="Utilisateur">
                    {% if e.user %}
                      <span class="u-login">{{ e.user.nom_utilisateur }}</span><span class="u-id">#{{ e.user_id }}</span>
                    {% elif e.user_id %}
                      <span class="u-login">#{{ e.user_id }}</span>
                    {% else %}
                      ‚Äî
                    {% endif %}
                  </td>
                  <td data-label="Action">{{ e.action }}</td>
                  <td data-label="Objet">{{ e.entity_type or "‚Äî" }}</td>
                  <td data-label="ID">{{ e.entity_id or "‚Äî" }}</td>
                  <td data-label="IP">{{ e.ip or "‚Äî" }}</td>
                  <td data-label="D√©tails" class="extra">{{ e.extra or "‚Äî" }}</td>
                </tr>
              {% else %}
                <tr><td data-label="Info" colspan="8" class="muted">Aucune entr√©e</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="table-actions">
          <div class="info"><span id="selected-count">0</span> s√©lectionn√©e(s)</div>
          <div class="actions">
            <button type="submit" class="btn btn-danger" id="delete-btn" disabled><i class="fa-solid fa-trash-can"></i> Supprimer la s√©lection</button>
            <button type="submit" class="btn btn-danger" name="delete_all" value="1" onclick="return confirm('Supprimer toutes les entr√©es du journal ?');"><i class="fa-solid fa-broom"></i> Tout supprimer</button>
          </div>
        </div>
      </form>
      <div class="pagination">
        {% if logs.has_prev %}
          <a class="btn" href="{{ url_for('main_bp.admin_logs', page=logs.prev_num, per_page=per_page, user_id=filters.user_id, action=filters.action, entity=filters.entity, q=filters.q) }}">&laquo; Pr√©c√©dent</a>
        {% endif %}
        <span class="muted">Page {{ logs.page }} / {{ logs.pages }}</span>
        {% if logs.has_next %}
          <a class="btn" href="{{ url_for('main_bp.admin_logs', page=logs.next_num, per_page=per_page, user_id=filters.user_id, action=filters.action, entity=filters.entity, q=filters.q) }}">Suivant &raquo;</a>
        {% endif %}
      </div>
    </section>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js" integrity="sha512-S2l2s7OGB+YQlaVKwfMV9cK8blOJbRRqtD9h5pz50jdK5Zk90un0nLBKBPXn1HULICwhf66A1Vpzr3rgIxeqkQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    const checkAll = document.getElementById('check-all');
    const rowChecks = Array.from(document.querySelectorAll('.row-check'));
    const deleteBtn = document.getElementById('delete-btn');
    const selectedCount = document.getElementById('selected-count');

    function refreshSelection(){
      const checked = rowChecks.filter(cb => cb.checked).length;
      selectedCount.textContent = checked;
      deleteBtn.disabled = checked === 0;
    }

    if(checkAll){
      checkAll.addEventListener('change', () => {
        rowChecks.forEach(cb => { cb.checked = checkAll.checked; });
        refreshSelection();
      });
    }
    rowChecks.forEach(cb => cb.addEventListener('change', () => {
      if(!cb.checked && checkAll){ checkAll.checked = false; }
      refreshSelection();
    }));

    refreshSelection();
  </script>
</body>
</html>
