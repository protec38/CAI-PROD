<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Tableau de bord</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- CSRF pour AJAX -->
  <meta name="csrf-token" content="{{ csrf_token() }}">

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    :root {
      --brand:#0c2f63;
      --brand-dark:#09224a;
      --accent:#f58220;
      --accent-soft:#ffede0;
      --success:#1d8348;
      --danger:#c0392b;
      --surface:#ffffff;
      --surface-muted:#f1f5fb;
      --ink:#0f172a;
      --muted:#4b5563;
      --border:#d9e2f3;
      --shadow:0 18px 40px rgba(15,35,71,.08);
    }
    *{box-sizing:border-box;}
    body{
      font-family:'Roboto',sans-serif;
      background:linear-gradient(180deg,#f7f9fc 0%,#edf2f9 40%,#e6effc 100%);
      color:var(--ink);
      margin:0;
      min-height:100vh;
      padding:24px 16px 48px;
    }
    a{color:inherit;}
    .app-header{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      gap:16px;
      justify-content:space-between;
      margin-bottom:24px;
    }
    .app-header__title{
      min-width:240px;
    }
    .app-header__title h1{
      margin:0;
      font-size:clamp(24px,3vw,32px);
      color:var(--brand);
      letter-spacing:.2px;
    }
    .app-header__title h1 i{
      margin-right:8px;
      color:var(--accent);
    }
    .app-header__subtitle{
      margin:6px 0 0;
      color:var(--muted);
      font-weight:500;
    }
    .actions-toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      justify-content:flex-end;
    }
    .btn{
      background:linear-gradient(135deg,var(--brand),var(--brand-dark));
      color:#fff;
      padding:10px 16px;
      text-decoration:none;
      border-radius:12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      border:1px solid rgba(9,34,74,.12);
      box-shadow:var(--shadow);
      transition:transform .1s ease, box-shadow .2s ease, filter .2s ease;
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 16px 34px rgba(12,47,99,.16);
      filter:brightness(1.02);
    }
    .btn:focus-visible{
      outline:3px solid rgba(12,47,99,.25);
      outline-offset:2px;
    }
    .btn-green{
      background:linear-gradient(135deg,#1d8348,#166534);
    }
    .btn-logout{
      background:linear-gradient(135deg,#f05a5a,#d12f2f);
    }
    .btn.btn-green,
    .btn.btn-logout{color:#fff;}
    .flashes{margin:12px 0;}
    .alert{
      padding:12px 14px;
      border-radius:12px;
      margin:6px 0;
      font-weight:600;
      border:1px solid transparent;
      background:var(--surface);
      box-shadow:var(--shadow);
    }
    .alert-success{border-color:rgba(29,131,72,.2);color:#146c43;}
    .alert-danger{border-color:rgba(192,57,43,.2);color:#a33224;}
    .alert-warning{border-color:rgba(245,130,32,.2);color:#c05621;}
    .alert-info{border-color:rgba(37,99,235,.2);color:#1d4ed8;}
    .event-info{
      background:var(--surface);
      padding:20px;
      border-radius:18px;
      margin-top:12px;
      margin-bottom:20px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
    }
    .event-info h2{
      margin:0 0 8px 0;
      color:var(--brand);
    }
    .event-row{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
    }
    .event-chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:var(--surface-muted);
      color:var(--brand);
      font-weight:700;
      border:1px solid var(--border);
    }
    .event-chip form select{
      min-height:36px;
      border-radius:10px;
      border:1px solid var(--border);
      padding:6px 10px;
      font-weight:600;
      color:var(--ink);
      background:#fff;
    }
    .filters-card{
      background:var(--surface);
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:18px 18px 22px;
      margin:0 0 24px;
    }
    .filters-card__header{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
    }
    .filters-card__header h3{
      margin:0;
      font-size:1.05rem;
      color:var(--brand);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .btn-toggle{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:none;
      background:var(--surface-muted);
      color:var(--brand);
      font-weight:700;
      border-radius:999px;
      padding:6px 14px;
      cursor:pointer;
      transition:background .2s ease, color .2s ease;
    }
    .btn-toggle:hover,
    .btn-toggle:focus-visible{
      background:var(--accent-soft);
      color:var(--accent);
      outline:none;
    }
    .btn-toggle__icon i{
      transition:transform .2s ease;
    }
    .filters-card.is-collapsed .btn-toggle__icon i{
      transform:rotate(180deg);
    }
    .filters{
      display:grid;
      gap:12px;
      margin:16px 0 0;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    }
    .filters-card.is-collapsed .filters{
      display:none;
    }
    .control{
      background:var(--surface-muted);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 14px;
      display:flex;
      gap:10px;
      align-items:center;
      min-height:58px;
    }
    .control.control--actions{
      justify-content:center;
    }
    .control input,
    .control select{
      flex:1;
      border:none;
      background:transparent;
      font-size:0.95rem;
      color:var(--ink);
    }
    .control input::placeholder{
      color:rgba(15,23,42,.5);
    }
    .control select{
      padding:0;
    }
    .control .tag{
      font-size:0.75rem;
      font-weight:800;
      color:var(--brand);
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:#fff;
      border:1px solid var(--border);
    }
    #filter-competences,
    #filter-statut{
      background:#fff;
      border-radius:10px;
      padding:6px 8px;
      border:1px solid var(--border);
      min-height:auto;
      max-height:160px;
    }
    #filter-competences[multiple]{height:150px;overflow:auto;}
    #filter-statut[multiple]{height:110px;overflow:auto;}
    .btn-small{
      padding:10px 16px;
      border-radius:999px;
      background:linear-gradient(135deg,var(--accent),#ff9746);
      color:#fff;
      border:none;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 10px 22px rgba(245,130,32,.22);
      transition:transform .1s ease, box-shadow .2s ease;
    }
    .btn-small i{margin-right:4px;}
    .btn-small:hover{
      transform:translateY(-1px);
      box-shadow:0 16px 28px rgba(245,130,32,.28);
    }
    .table-wrap{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:20px;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      box-shadow:var(--shadow);
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width:980px;
      color:var(--ink);
    }
    thead th{
      position:sticky;
      top:0;
      z-index:1;
      background:linear-gradient(90deg,var(--brand),#1d5ca8);
      color:#fff;
      font-weight:800;
      letter-spacing:.28px;
      padding:14px 12px;
      text-align:left;
    }
    thead th .th-label{
      display:flex;
      align-items:center;
      gap:8px;
    }
    tbody td{
      padding:13px 12px;
      border-bottom:1px solid var(--border);
      vertical-align:top;
    }
    tbody tr:nth-child(odd){
      background:rgba(12,47,99,.03);
    }
    tbody tr:hover{
      background:rgba(12,47,99,.08);
    }
    .badge{
      padding:6px 12px;
      border-radius:999px;
      font-weight:700;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:0.85rem;
    }
    .badge.present{background:rgba(29,131,72,.15);color:#166534;}
    .badge.sorti{background:rgba(245,130,32,.15);color:#b45309;}
    .badge.supprime{background:rgba(192,57,43,.15);color:#a33224;}
    .badge-orange { background: rgba(245,130,32,.16); color: #b45309; }
    .badge-green { background: rgba(29,131,72,.16); color: #166534; }
    .badge-red { background: rgba(192,57,43,.16); color: #a33224; }
    .badge-blue { background: rgba(37,99,235,.16); color: #1d4ed8; }
    .badge-dark { background: rgba(15,23,42,.12); color: #0f172a; }
    .badge-bagage{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:var(--surface-muted);
      color:var(--brand);
      font-size:0.75rem;
      font-weight:700;
    }
    .bagages-cell{min-width:160px;}
    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn-action{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:9px 12px;
      border-radius:12px;
      font-weight:700;
      text-decoration:none;
      border:1px solid var(--border);
      cursor:pointer;
      transition:transform .05s ease, box-shadow .2s ease;
      background:var(--surface-muted);
      color:var(--brand);
      box-shadow:0 6px 16px rgba(15,35,71,.08);
      font-size:0.9rem;
    }
    .btn-action:hover{
      transform:translateY(-1px);
      box-shadow:0 10px 20px rgba(15,35,71,.12);
    }
    .btn-blue{background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;border:none;}
    .btn-yellow{background:linear-gradient(135deg,#fcd34d,#f59e0b);color:#78350f;border:none;}
    .btn-orange{background:linear-gradient(135deg,#fb923c,#f97316);color:#7c2d12;border:none;}
    .btn-red{background:linear-gradient(135deg,#f87171,#ef4444);color:#7f1d1d;border:none;}
    .actions a{color:inherit;font-weight:inherit;text-decoration:none;}
    .actions form{display:inline-block;margin:0;}
    .actions form button{all:unset;display:inline-flex;align-items:center;gap:6px;}
    select[name="statut_evt"]{
      padding:6px 8px;
      font-weight:600;
      background:#fff;
      color:var(--ink);
      border-radius:10px;
      border:1px solid var(--border);
    }
    .badge-competence{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 10px;
      border-radius:999px;
      color:#fff;
      font-size:0.8rem;
      font-weight:700;
      margin:2px;
    }
    .modal{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
    }
    .modal-content{
      background:#fff;
      color:var(--ink);
      width:min(520px,92vw);
      border-radius:18px;
      box-shadow:0 22px 48px rgba(15,23,42,.25);
      overflow:hidden;
    }
    .modal-header,
    .modal-footer{
      padding:16px 18px;
      background:#f8fafc;
      border-bottom:1px solid var(--border);
    }
    .modal-footer{
      border-top:1px solid var(--border);
      border-bottom:none;
    }
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .modal-header h3{
      margin:0;
      font-size:1.1rem;
      color:var(--brand);
    }
    .modal-content form{
      padding:18px;
    }
    .modal .form-group{margin-bottom:14px;}
    .modal label{
      display:block;
      font-weight:700;
      margin-bottom:6px;
      color:var(--muted);
    }
    .modal input[type="text"],
    .modal textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      font-size:0.95rem;
      background:#fff;
    }
    .modal small.hint{
      display:block;
      color:var(--muted);
      margin-top:4px;
    }
    .modal .close{
      background:transparent;
      border:0;
      font-size:22px;
      cursor:pointer;
      color:var(--muted);
    }
    .modal-footer{
      display:flex;
      gap:10px;
      justify-content:flex-end;
    }
    @media (max-width:960px){
      .actions-toolbar{justify-content:flex-start;}
    }
    @media (max-width:720px){
      body{padding:20px 12px 40px;}
      .app-header{flex-direction:column;align-items:flex-start;}
      .actions-toolbar{width:100%;}
      .filters-card{padding:16px;}
    }
    @media (max-width:580px){
      .filters{grid-template-columns:1fr;}
      .actions-toolbar{gap:10px;}
      .btn{width:100%;justify-content:center;}
    }
  </style>
</head>

<body>
  <header class="app-header">
    <div class="app-header__title">
      <h1><i class="fa-solid fa-chart-line"></i> Tableau de bord</h1>
      <p class="app-header__subtitle">Pilotage opérationnel et suivi des participants</p>
    </div>

    <div class="actions-toolbar">
      <a href="{{ url_for('main_bp.evenement_new') }}" class="btn"><i class="fa-solid fa-gear"></i> Gestion des évènements</a>
      <a href="{{ url_for('main_bp.fiche_new') }}" class="btn btn-green"><i class="fa-solid fa-user-plus"></i> Créer une fiche impliquée</a>
      {% if user.is_admin or user.role in ["codep", "responsable"] %}
        <a href="{{ url_for('main_bp.autorite_dashboard_manage', evenement_id=evenement.id) }}" class="btn"><i class="fa-solid fa-eye"></i> Vue Autorité & Partage</a>
      {% endif %}
      {% if user.is_admin or user.role == "codep" or (user.role == "responsable" and user in evenement.utilisateurs) %}
        <a href="{{ url_for('main_bp.export_evenement_fiches_pdf', evenement_id=evenement.id) }}" class="btn"><i class="fa-solid fa-file-pdf"></i> Export PDF</a>
        <a href="{{ url_for('main_bp.export_evenement_fiches_csv', evenement_id=evenement.id) }}" class="btn"><i class="fa-solid fa-file-csv"></i> Export CSV</a>
      {% endif %}
      {% if user.is_admin or user.role|lower in ['codep','responsable','logisticien'] %}
        <a href="{{ url_for('main_bp.tickets_board', evenement_id=evenement.id) }}" class="btn"><i class="fa-solid fa-ticket"></i> Tickets</a>
      {% endif %}
      <a href="{{ url_for('main_bp.logout') }}" class="btn btn-logout"><i class="fa-solid fa-right-from-bracket"></i> Déconnexion</a>
    </div>
  </header>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flashes">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {% if evenement %}
  <div class="event-info">
    <h2 id="evt-nom"><i class="fas fa-calendar-alt"></i> {{ evenement.nom }}</h2>
    <div class="event-row" style="margin:6px 0 10px;">
      <span class="event-chip">
        <i class="fa-solid fa-location-dot"></i>
        <span id="evt-adresse">{{ evenement.adresse }}</span>
      </span>
      <span class="event-chip"><i class="fa-solid fa-clock"></i> Créé le {{ evenement.date_ouverture_locale.strftime('%d/%m/%Y %H:%M') }}</span>
      <span class="event-chip"><i class="fa-solid fa-user-group"></i> <strong id="nb_present">{{ nb_present }}</strong> / <span id="nb_total">{{ nb_total }}</span> présents</span>
      <span class="event-chip">
        {% if peut_modifier_statut %}
          <form method="POST" action="{{ url_for('main_bp.update_evenement_statut', evenement_id=evenement.id) }}" style="margin:0;display:flex;gap:8px;align-items:center">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <i class="fa-solid fa-signal"></i>
            <select id="evt-statut-select" name="statut_evt" onchange="this.form.submit()">
              {% for option in ['En cours de gréement', 'Ouvert', 'Effectif dépassé', 'Complet', 'Fermé'] %}
              <option value="{{ option }}" {% if evenement.statut == option %}selected{% endif %}>{{ option }}</option>
              {% endfor %}
            </select>
          </form>
        {% else %}
          <span id="statut-lecture-seule">
            {% if evenement.statut == "En cours de gréement" %}
              <span class="badge badge-orange"><i class="fa-solid fa-hourglass-half"></i> {{ evenement.statut }}</span>
            {% elif evenement.statut == "Ouvert" %}
              <span class="badge badge-green"><i class="fa-solid fa-door-open"></i> {{ evenement.statut }}</span>
            {% elif evenement.statut == "Effectif dépassé" %}
              <span class="badge badge-red"><i class="fa-solid fa-user-times"></i> {{ evenement.statut }}</span>
            {% elif evenement.statut == "Complet" %}
              <span class="badge badge-blue"><i class="fa-solid fa-circle-check"></i> {{ evenement.statut }}</span>
            {% elif evenement.statut == "Fermé" %}
              <span class="badge badge-dark"><i class="fa-solid fa-lock"></i> {{ evenement.statut }}</span>
            {% else %}
              {{ evenement.statut }}
            {% endif %}
          </span>
        {% endif %}
      </span>
    </div>
  </div>
  {% endif %}

  <!-- Filtres -->
  <section class="filters-card is-collapsed" aria-label="Filtres de recherche">
    <div class="filters-card__header">
      <h3><i class="fa-solid fa-sliders"></i> Affiner la liste</h3>
      <button type="button" class="btn-toggle" id="toggle-filters" aria-expanded="false" aria-controls="filters-grid">
        <span class="btn-toggle__icon"><i class="fa-solid fa-chevron-down"></i></span>
        <span class="btn-toggle__label">Afficher</span>
      </button>
    </div>
    <div class="filters" id="filters-grid">
      <div class="control">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input type="text" id="search-bar" placeholder="Rechercher par nom ou prénom…">
      </div>
      <div class="control">
        <span class="tag"><i class="fa-solid fa-filter"></i> Statuts</span>
        <select id="filter-statut" multiple size="4">
          <option value="présent">Présent</option>
          <option value="sorti">Sorti</option>
          <option value="supprimé">Supprimé</option>
        </select>
      </div>
      <div class="control">
        <span class="tag"><i class="fa-solid fa-filter"></i> Compétences</span>
        <select id="filter-competences" multiple size="4">
          {% for comp in competence_colors.keys() %}
            <option value="{{ comp }}">{{ comp }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="control control--actions">
        <button class="btn-small" id="btn-reset-filters"><i class="fa-solid fa-rotate"></i> Réinitialiser</button>
      </div>
    </div>
  </section>

  <!-- Tableau -->
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th><span class="th-label"><i class="fa-solid fa-hashtag"></i> Numéro</span></th>
          <th><span class="th-label"><i class="fa-solid fa-user"></i> Nom</span></th>
          <th><span class="th-label"><i class="fa-regular fa-user"></i> Prénom</span></th>
          <th><span class="th-label"><i class="fa-solid fa-circle-check"></i> Statut</span></th>
          <th><span class="th-label"><i class="fa-regular fa-clock"></i> Heure d’arrivée</span></th>
          <th><span class="th-label"><i class="fa-solid fa-triangle-exclamation"></i> Difficultés</span></th>
          <th><span class="th-label"><i class="fa-solid fa-award"></i> Compétences</span></th>
          <th><span class="th-label"><i class="fa-solid fa-suitcase-rolling"></i> Bagages</span></th>
          <th><span class="th-label"><i class="fa-solid fa-ellipsis"></i> Actions</span></th>
        </tr>
      </thead>
      <tbody id="fiches-table-body"></tbody>
    </table>
  </div>

  <!-- Modal Bagage -->
  <div id="modal-bagage" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fa-solid fa-suitcase-rolling"></i> Rattacher bagage(s)</h3>
        <button class="close" onclick="fermerModalBagage()" aria-label="Fermer">&times;</button>
      </div>
      <form id="form-bagage" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-group">
          <label>Fiche</label>
          <input type="text" id="bagage-fiche-numero" value="" readonly />
          <input type="hidden" id="bagage-fiche-id" name="fiche_id" value="">
        </div>
        <div class="form-group">
          <label for="numeros">Numéro(s) de bagage</label>
          <textarea name="numeros" id="numeros" rows="3" maxlength="300" placeholder="Ex : BAG-001, BAG-002 BAG-003"></textarea>
          <small class="hint">Séparez par virgules, espaces ou retours à la ligne.</small>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn-action btn-orange"><i class="fa-solid fa-plus"></i> <span>Enregistrer</span></button>
          <button type="button" class="btn-action" onclick="fermerModalBagage()"><i class="fa-solid fa-xmark"></i> <span>Annuler</span></button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Sortie -->
  <div id="modal-sortie" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fa-solid fa-person-walking-arrow-right"></i> Déclarer la sortie</h3>
        <button class="close" onclick="fermerModalSortie()" aria-label="Fermer">&times;</button>
      </div>
      <form id="form-sortie" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-group">
          <label>Fiche</label>
          <input type="text" id="sortie-fiche-numero" value="" readonly />
          <input type="hidden" id="sortie-fiche-id" value="">
        </div>
        <div class="form-group">
          <label for="sortie-destination">Destination</label>
          <input type="text" id="sortie-destination" name="destination" maxlength="100" placeholder="Ex : Domicile, CHU, Famille…">
        </div>
        <div class="form-group">
          <label for="sortie-moyen">Moyen de transport</label>
          <input type="text" id="sortie-moyen" name="moyen_transport" maxlength="100" placeholder="Ex : Bus, Ambulance, Véhicule perso…">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn-action btn-orange"><i class="fa-solid fa-check"></i> <span>Valider la sortie</span></button>
          <button type="button" class="btn-action" onclick="fermerModalSortie()"><i class="fa-solid fa-xmark"></i> <span>Annuler</span></button>
        </div>
      </form>
    </div>
  </div>

  <script>
    /* Droit suppression (évalué serveur) */
    const CAN_DELETE_FICHE = {{ 'true' if (user.is_admin or (user.role|lower in ['codep','responsable'])) else 'false' }};

    /* CSRF header pour tous les fetch */
    const CSRF_TOKEN = (document.querySelector('meta[name="csrf-token"]')?.content || '');
    const FETCH_HEADERS = {
      'Accept': 'application/json',
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRFToken': CSRF_TOKEN
    };

    /* Utils DOM */
    function setHTMLIfChanged(el, html){
      if(!el) return;
      const next=(html||"").trim();
      const prev=(el.innerHTML||"").trim();
      if(next!==prev) el.innerHTML=html;
    }
    function setTextIfChanged(el, text){
      if(!el) return;
      const next=(text||"").trim();
      const prev=(el.textContent||"").trim();
      if(next!==prev) el.textContent=text;
    }

    /* UI helpers */
    function getStatutHtml(statut){
      if(statut==='présent') return '<span class="badge present"><i class="fas fa-check-circle"></i> Présent</span>';
      if(statut==='sorti') return '<span class="badge sorti"><i class="fas fa-sign-out-alt"></i> Sorti</span>';
      if(statut==='supprimé') return '<span class="badge supprime"><i class="fas fa-trash-alt"></i> Supprimé</span>';
      return statut || '';
    }
    function getStatutEvenementHTML(statut) {
      switch (statut) {
        case "En cours de gréement": return `<span class="badge badge-orange"><i class="fa-solid fa-hourglass-half"></i> ${statut}</span>`;
        case "Ouvert": return `<span class="badge badge-green"><i class="fa-solid fa-door-open"></i> ${statut}</span>`;
        case "Effectif dépassé": return `<span class="badge badge-red"><i class="fa-solid fa-user-times"></i> ${statut}</span>`;
        case "Complet": return `<span class="badge badge-blue"><i class="fa-solid fa-circle-check"></i> ${statut}</span>`;
        case "Fermé": return `<span class="badge badge-dark"><i class="fa-solid fa-lock"></i> ${statut}</span>`;
        default: return statut || '';
      }
    }
    function renderCompetenceBadges(raw){
      if(!raw) return "<em>Aucune</em>";
      const colorMap={{ competence_colors | tojson | safe }};
      return raw.split(',').map(c=>{
        const comp=c.trim(); const color=colorMap[comp]||"#999";
        return `<span class="badge-competence" style="background:${color}">${comp}</span>`;
      }).join(" ");
    }
    function renderBagageBadges(numeros){
      if(!numeros || !numeros.length) return '<em>Aucun</em>';
      return numeros.map(n=>`<span class="badge-bagage"><i class="fa-solid fa-suitcase-rolling"></i> ${n}</span>`).join(' ');
    }

    function normalizeStatutValue(raw){
      return (raw ?? '').toString().trim().toLowerCase();
    }

    function extractCompetenceList(raw){
      if(!raw) return [];
      if(Array.isArray(raw)) return raw;
      return String(raw)
        .split(',')
        .map(c=>c.trim())
        .filter(Boolean);
    }

    function buildCompetenceDataset(raw){
      return extractCompetenceList(raw)
        .map(c=>c.toLowerCase())
        .join('|');
    }

    function actionsHTML(f){
      const delBtn = CAN_DELETE_FICHE ? `
        <form method="POST" action="/fiche/delete/${f.id}" onsubmit="return confirm('Confirmer la suppression ?');">
          <input type="hidden" name="csrf_token" value="${CSRF_TOKEN}">
          <button type="submit" class="btn-action btn-red" title="Supprimer la fiche">
            <i class="fa-solid fa-trash-can"></i> <span>Supprimer</span>
          </button>
        </form>` : ``;

      return `
        <div class="actions">
          <a class="btn-action btn-blue" href="/fiche/${f.id}" title="Voir la fiche"><i class="fa-solid fa-eye"></i> <span>Voir</span></a>
          <a class="btn-action btn-yellow" href="/fiche/edit/${f.id}" title="Modifier la fiche"><i class="fa-solid fa-pen-to-square"></i> <span>Modifier</span></a>
          <button class="btn-action btn-orange" type="button" title="Déclarer la sortie" onclick="ouvrirModalSortie(${f.id}, '${f.numero}')">
            <i class="fa-solid fa-person-walking-arrow-right"></i> <span>Sortie</span>
          </button>
          <button class="btn-action btn-orange" type="button" title="Ajouter / modifier les bagages" onclick="ouvrirModalBagage(${f.id}, '${f.numero}')">
            <i class="fa-solid fa-suitcase-rolling"></i> <span>Bagage</span>
          </button>
          ${delBtn}
        </div>`;
    }

    function ligneFicheHTML(f){
      return `
        <tr id="fiche-row-${f.id}">
          <td data-col="numero">${f.numero}</td>
          <td data-col="nom">${f.nom}</td>
          <td data-col="prenom">${f.prenom}</td>
          <td data-col="statut">${getStatutHtml(f.statut)}</td>
          <td data-col="heure_arrivee">${f.heure_arrivee}</td>
          <td data-col="difficultes">${f.difficultes || ""}</td>
          <td data-col="competences">${renderCompetenceBadges(f.competences)}</td>
          <td class="bagages-cell"><div id="bagages-${f.id}"><em>Chargement…</em></div></td>
          <td data-col="actions">${actionsHTML(f)}</td>
        </tr>`;
    }

    const rowsCache=new Map();

    function upsertRow(f){
      const tbody=document.getElementById("fiches-table-body");
      let tr=document.getElementById(`fiche-row-${f.id}`);
      if(!tr){
        tbody.insertAdjacentHTML('beforeend', ligneFicheHTML(f));
        tr=document.getElementById(`fiche-row-${f.id}`);
      }else{
        setTextIfChanged(tr.querySelector('[data-col="numero"]'), f.numero);
        setTextIfChanged(tr.querySelector('[data-col="nom"]'), f.nom);
        setTextIfChanged(tr.querySelector('[data-col="prenom"]'), f.prenom);
        setHTMLIfChanged(tr.querySelector('[data-col="statut"]'), getStatutHtml(f.statut));
        const h=tr.querySelector('[data-col="heure_arrivee"]'); if(h) setTextIfChanged(h, f.heure_arrivee);
        const d=tr.querySelector('[data-col="difficultes"]'); if(d) setTextIfChanged(d, f.difficultes || "");
        const c=tr.querySelector('[data-col="competences"]'); if(c) setHTMLIfChanged(c, renderCompetenceBadges(f.competences));
      }
      if(tr){
        tr.dataset.statut = normalizeStatutValue(f.statut);
        tr.dataset.competences = buildCompetenceDataset(f.competences);
      }
      rowsCache.set(f.id, f);
      majBagagesCell(f.id);
    }

    async function majBagagesCell(ficheId){
      try{
        const r = await fetch(`/fiche/${ficheId}/bagages_json`, { credentials:'include', headers: FETCH_HEADERS });
        const d = await r.json();
        const cible=document.getElementById(`bagages-${ficheId}`);
        if(!cible) return;
        const html=(d && Array.isArray(d.numeros))? renderBagageBadges(d.numeros) : '<em>Aucun</em>';
        setHTMLIfChanged(cible, html);
      }catch(_){
        const cible=document.getElementById(`bagages-${ficheId}`);
        if(cible) setHTMLIfChanged(cible, '<em>—</em>');
      }
    }

    function getSelectValues(sel){ return Array.from(sel.selectedOptions||[]).map(o=>o.value); }

    function rowMatchesFilters(row, f){
      const searchTerm=(document.getElementById("search-bar").value||"").toLowerCase();
      const nom=row.children[1]?.textContent.toLowerCase()||"";
      const prenom=row.children[2]?.textContent.toLowerCase()||"";
      const searchOk=!searchTerm || nom.includes(searchTerm) || prenom.includes(searchTerm);

      const selectedStatus=getSelectValues(document.getElementById('filter-statut')).map(normalizeStatutValue);
      const statutTxt=normalizeStatutValue(f?.statut ?? row?.dataset?.statut ?? '');
      const statusOk=selectedStatus.length===0 || selectedStatus.includes(statutTxt);

      const selectedComps=getSelectValues(document.getElementById('filter-competences')).map(c=>c.toLowerCase());
      const ficheComps=f
        ? extractCompetenceList(f.competences).map(c=>c.toLowerCase())
        : (row?.dataset?.competences||'').split('|').filter(Boolean);
      const compOk=selectedComps.length===0 || ficheComps.some(c=>selectedComps.includes(c));

      return searchOk && statusOk && compOk;
    }

    function applyAllFilters(){
      const rows=document.querySelectorAll("#fiches-table-body tr");
      rows.forEach(row=>{
        const id=Number(row.id.replace('fiche-row-',''));
        const f=rowsCache.get(id);
        row.style.display=rowMatchesFilters(row,f)? "":"none";
      });
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      ['modal-bagage','modal-sortie'].forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.style.display='none';
      });
      ['modal-bagage','modal-sortie'].forEach(id=>{
        const m=document.getElementById(id);
        if(!m) return;
        m.addEventListener('click', (e)=>{ if(e.target===m) m.style.display='none'; });
      });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ fermerModalBagage(); fermerModalSortie(); } });

      const filtersCard=document.querySelector('.filters-card');
      const toggleFiltersBtn=document.getElementById('toggle-filters');
      const toggleFiltersLabel=toggleFiltersBtn?.querySelector('.btn-toggle__label');
      const toggleFiltersIcon=toggleFiltersBtn?.querySelector('.btn-toggle__icon i');
      if(filtersCard && toggleFiltersBtn){
        const syncFiltersToggle=(expanded)=>{
          toggleFiltersBtn.setAttribute('aria-expanded', expanded ? 'true':'false');
          if(toggleFiltersLabel){
            toggleFiltersLabel.textContent = expanded ? 'Réduire' : 'Afficher';
          }
          if(toggleFiltersIcon){
            toggleFiltersIcon.classList.remove('fa-chevron-up','fa-chevron-down');
            toggleFiltersIcon.classList.add(expanded ? 'fa-chevron-up' : 'fa-chevron-down');
          }
        };

        // État initial : filtres repliés
        filtersCard.classList.add('is-collapsed');
        syncFiltersToggle(false);

        toggleFiltersBtn.addEventListener('click',()=>{
          const collapsed = filtersCard.classList.toggle('is-collapsed');
          syncFiltersToggle(!collapsed);
        });
      }

      document.getElementById("search-bar").addEventListener("input", applyAllFilters);
      document.getElementById("filter-statut").addEventListener("change", applyAllFilters);
      document.getElementById("filter-competences").addEventListener("change", applyAllFilters);
      document.getElementById("btn-reset-filters").addEventListener("click",(e)=>{
        e.preventDefault();
        document.getElementById("search-bar").value="";
        Array.from(document.getElementById("filter-statut").options).forEach(o=>o.selected=false);
        Array.from(document.getElementById("filter-competences").options).forEach(o=>o.selected=false);
        applyAllFilters();
      });

      refreshFiches();
      setInterval(refreshFiches, 3000);
    });

    async function refreshFiches(){
      try{
        const res = await fetch(`/evenement/{{ evenement.id }}/fiches_json`, { credentials:'include', headers: FETCH_HEADERS });
        const data = await res.json();

        const idsActuels = new Set();
        (data.fiches || []).forEach(f => {
          idsActuels.add(f.id);
          upsertRow(f);
        });

        Array.from(rowsCache.keys()).forEach(id => {
          if(!idsActuels.has(id)){
            const tr = document.getElementById(`fiche-row-${id}`);
            if(tr) tr.remove();
            rowsCache.delete(id);
          }
        });

        const nbp = document.getElementById("nb_present");
        const nbt = document.getElementById("nb_total");
        if(nbp) setTextIfChanged(nbp, String(data.nb_present || 0));
        if(nbt) setTextIfChanged(nbt, String(data.nb_total || 0));

        if (data.evenement && data.evenement.adresse) {
          const adrEl = document.getElementById("evt-adresse");
          if (adrEl && adrEl.textContent.trim() !== data.evenement.adresse.trim()) adrEl.textContent = data.evenement.adresse;
        }
        const statutSelect = document.getElementById("evt-statut-select");
        if (statutSelect && data.evenement && data.evenement.statut) {
          if (statutSelect.value.trim() !== data.evenement.statut.trim()) statutSelect.value = data.evenement.statut.trim();
        }
        if (data.evenement && data.evenement.nom) {
          const nomEl = document.getElementById("evt-nom");
          if (nomEl && nomEl.textContent.trim() !== data.evenement.nom.trim()) nomEl.textContent = data.evenement.nom;
        }
        if (data.evenement && data.evenement.statut) {
          const statutEl = document.getElementById("statut-lecture-seule");
          const newHTML = getStatutEvenementHTML(data.evenement.statut);
          if (statutEl && statutEl.innerHTML.trim() !== newHTML.trim()) statutEl.innerHTML = newHTML;
        }

        applyAllFilters();
      }catch(err){
        console.error("Erreur refreshFiches:", err);
      }
    }

    function ouvrirModalBagage(ficheId, ficheNumero){
      const form=document.getElementById('form-bagage');
      form.action="/fiche/"+ficheId+"/bagages/ajouter";
      document.getElementById('bagage-fiche-id').value=ficheId;
      document.getElementById('bagage-fiche-numero').value=ficheNumero||("#"+ficheId);
      document.getElementById('numeros').value="";
      fetch("/fiche/"+ficheId+"/bagages_json", { credentials:'include', headers: FETCH_HEADERS })
        .then(r=>r.json())
        .then(data=>{
          if(data && Array.isArray(data.numeros)){
            document.getElementById('numeros').value=data.numeros.join(", ");
          }
          document.getElementById('modal-bagage').style.display='flex';
          setTimeout(()=>document.getElementById('numeros').focus(),50);
        })
        .catch(()=>{
          document.getElementById('modal-bagage').style.display='flex';
          setTimeout(()=>document.getElementById('numeros').focus(),50);
        });
    }
    function fermerModalBagage(){
      const m=document.getElementById('modal-bagage'); if(m) m.style.display='none';
    }

    function ouvrirModalSortie(ficheId, ficheNumero, destination="", moyen=""){
      const form=document.getElementById('form-sortie');
      form.action="/fiche/"+ficheId+"/sortie";
      document.getElementById('sortie-fiche-id').value=ficheId;
      document.getElementById('sortie-fiche-numero').value=ficheNumero||("#"+ficheId);
      document.getElementById('sortie-destination').value=destination||"";
      document.getElementById('sortie-moyen').value=moyen||"";
      document.getElementById('modal-sortie').style.display='flex';
      setTimeout(()=>document.getElementById('sortie-destination').focus(),50);
    }
    function fermerModalSortie(){
      const m=document.getElementById('modal-sortie'); if(m) m.style.display='none';
    }
  </script>
</body>
</html>
