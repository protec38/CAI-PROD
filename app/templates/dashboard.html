<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Tableau de bord</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  
</head>

<body>
  <div class="header">
    <h1><i class="fa-solid fa-chart-line"></i> Tableau de bord</h1>
    <div>
      <a href="{{ url_for('main_bp.evenement_new') }}" class="btn"><i class="fa-solid fa-gear"></i> Gestion des √©v√®nements</a>
      <a href="{{ url_for('main_bp.fiche_new') }}" class="btn btn-green"><i class="fa-solid fa-user-plus"></i> Cr√©er une fiche impliqu√©e</a>
      <a href="{{ url_for('main_bp.logout') }}" class="btn"><i class="fa-solid fa-right-from-bracket"></i> D√©connexion</a>
    {% if user.is_admin or user.role in ["codep", "responsable"] %}
      <a href="{{ url_for('main_bp.autorite_dashboard_manage', evenement_id=evenement.id) }}" class="btn">
        <i class="fa-solid fa-eye"></i> Vue Autorit√© & Partage
      </a>
    {% endif %}
      {% if user.is_admin or user.role == "codep" or (user.role == "responsable" and user in evenement.utilisateurs) %}
        <a href="{{ url_for('main_bp.export_evenement_fiches_pdf', evenement_id=evenement.id) }}" class="btn">
          <i class="fa-solid fa-file-pdf"></i> Export PDF
        </a>
        <a href="{{ url_for('main_bp.export_evenement_fiches_csv', evenement_id=evenement.id) }}" class="btn">
          <i class="fa-solid fa-file-csv"></i> Export CSV
        </a>
      {% endif %}

      {% if user.is_admin or user.role|lower in ['codep','responsable','logisticien'] %}
        <a href="{{ url_for('main_bp.tickets_board', evenement_id=evenement.id) }}" class="btn">
          <i class="fa-solid fa-ticket"></i> Tickets
        </a>
      {% endif %}
    </div>
  </div>


  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flashes">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {% if evenement %}
  <div class="event-info">
    <h2 id="evt-nom"><i class="fas fa-calendar-alt"></i> {{ evenement.nom }}</h2>
    <div class="event-row" style="margin:6px 0 10px;">
      <span class="event-chip">
        <i class="fa-solid fa-location-dot"></i>
        <span id="evt-adresse">{{ evenement.adresse }}</span>
      </span>
      <span class="event-chip"><i class="fa-solid fa-clock"></i> Cr√©√© le {{ evenement.date_ouverture_locale.strftime('%d/%m/%Y %H:%M') }}</span>
      <span class="event-chip"><i class="fa-solid fa-user-group"></i> <strong id="nb_present">{{ nb_present }}</strong> / <span id="nb_total">{{ nb_total }}</span> pr√©sents</span>
      <span class="event-chip">
        {% if peut_modifier_statut %}
          <form method="POST" action="{{ url_for('main_bp.update_evenement_statut', evenement_id=evenement.id) }}" style="margin:0;display:flex;gap:8px;align-items:center">
            <i class="fa-solid fa-signal"></i>
            <select id="evt-statut-select" name="statut_evt" onchange="this.form.submit()">
              {% for option in ['En cours de gr√©ement', 'Ouvert', 'Effectif d√©pass√©', 'Complet', 'Ferm√©'] %}
              <option value="{{ option }}" {% if evenement.statut == option %}selected{% endif %}>{{ option }}</option>
              {% endfor %}
            </select>
          </form>
        {% else %}
          <span id="statut-lecture-seule">
            {% if evenement.statut == "En cours de gr√©ement" %}
              <span class="badge badge-orange"><i class="fa-solid fa-hourglass-half"></i> {{ evenement.statut }}</span>
            {% elif evenement.statut == "Ouvert" %}
              <span class="badge badge-green"><i class="fa-solid fa-door-open"></i> {{ evenement.statut }}</span>
            {% elif evenement.statut == "Effectif d√©pass√©" %}
              <span class="badge badge-red"><i class="fa-solid fa-user-times"></i> {{ evenement.statut }}</span>
            {% elif evenement.statut == "Complet" %}
              <span class="badge badge-blue"><i class="fa-solid fa-circle-check"></i> {{ evenement.statut }}</span>
            {% elif evenement.statut == "Ferm√©" %}
              <span class="badge badge-dark"><i class="fa-solid fa-lock"></i> {{ evenement.statut }}</span>
            {% else %}
              {{ evenement.statut }}
        {% endif %}
  </span>
{% endif %}
      </span>
    </div>
  </div>
  {% endif %}

  <!-- üîé Filtres + Recherche -->
  <div class="filters">
    <div class="control">
      <i class="fa-solid fa-magnifying-glass"></i>
      <input type="text" id="search-bar" placeholder="Rechercher par nom ou pr√©nom‚Ä¶">
    </div>
    <div class="control">
      <span class="tag"><i class="fa-solid fa-filter"></i> Statuts</span>
      <select id="filter-statut" multiple size="4">
        <option value="pr√©sent">Pr√©sent</option>
        <option value="sorti">Sorti</option>
        <option value="supprim√©">Supprim√©</option>
      </select>
    </div>
    <div class="control">
      <span class="tag"><i class="fa-solid fa-filter"></i> Comp√©tences</span>
      <select id="filter-competences" multiple size="4">
        {% for comp in competence_colors.keys() %}
          <option value="{{ comp }}">{{ comp }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="control" style="justify-content:center">
      <button class="btn-small" id="btn-reset-filters"><i class="fa-solid fa-rotate"></i> R√©initialiser</button>
    </div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th><span class="th-label"><i class="fa-solid fa-hashtag"></i> Num√©ro</span></th>
          <th><span class="th-label"><i class="fa-solid fa-user"></i> Nom</span></th>
          <th><span class="th-label"><i class="fa-regular fa-user"></i> Pr√©nom</span></th>
          <th><span class="th-label"><i class="fa-solid fa-circle-check"></i> Statut</span></th>
          <th><span class="th-label"><i class="fa-regular fa-clock"></i> Heure d‚Äôarriv√©e</span></th>
          <th><span class="th-label"><i class="fa-solid fa-triangle-exclamation"></i> Difficult√©s</span></th>
          <th><span class="th-label"><i class="fa-solid fa-award"></i> Comp√©tences</span></th>
          <th><span class="th-label"><i class="fa-solid fa-suitcase-rolling"></i> Bagages</span></th>
          <th><span class="th-label"><i class="fa-solid fa-ellipsis"></i> Actions</span></th>
        </tr>
      </thead>
      <tbody id="fiches-table-body"></tbody>
    </table>
  </div>

  <!-- ===== Modal : Bagage ===== -->
  <div id="modal-bagage" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fa-solid fa-suitcase-rolling"></i> Rattacher bagage(s)</h3>
        <button class="close" onclick="fermerModalBagage()" aria-label="Fermer">&times;</button>
      </div>
      <form id="form-bagage" method="post">
        <div class="form-group">
          <label>Fiche</label>
          <input type="text" id="bagage-fiche-numero" value="" readonly />
          <input type="hidden" id="bagage-fiche-id" name="fiche_id" value="">
        </div>
        <div class="form-group">
          <label for="numeros">Num√©ro(s) de bagage</label>
          <textarea name="numeros" id="numeros" rows="3" maxlength="300" placeholder="Ex : BAG-001, BAG-002 BAG-003"></textarea>
          <small class="hint">S√©parez par virgules, espaces ou retours √† la ligne.</small>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn-action btn-orange"><i class="fa-solid fa-plus"></i> <span>Enregistrer</span></button>
          <button type="button" class="btn-action" onclick="fermerModalBagage()"><i class="fa-solid fa-xmark"></i> <span>Annuler</span></button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== Modal : Sortie ===== -->
  <div id="modal-sortie" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fa-solid fa-person-walking-arrow-right"></i> D√©clarer la sortie</h3>
        <button class="close" onclick="fermerModalSortie()" aria-label="Fermer">&times;</button>
      </div>
      <form id="form-sortie" method="post">
        <div class="form-group">
          <label>Fiche</label>
          <input type="text" id="sortie-fiche-numero" value="" readonly />
          <input type="hidden" id="sortie-fiche-id" value="">
        </div>
        <div class="form-group">
          <label for="sortie-destination">Destination</label>
          <input type="text" id="sortie-destination" name="destination" maxlength="100" placeholder="Ex : Domicile, CHU, Famille‚Ä¶">
        </div>
        <div class="form-group">
          <label for="sortie-moyen">Moyen de transport</label>
          <input type="text" id="sortie-moyen" name="moyen_transport" maxlength="100" placeholder="Ex : Bus, Ambulance, V√©hicule perso‚Ä¶">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn-action btn-orange"><i class="fa-solid fa-check"></i> <span>Valider la sortie</span></button>
          <button type="button" class="btn-action" onclick="fermerModalSortie()"><i class="fa-solid fa-xmark"></i> <span>Annuler</span></button>
        </div>
      </form>
    </div>
  </div>

  <script>
    /* === R√®gle d'affichage du bouton Supprimer (√©valu√©e c√¥t√© serveur) === */
    const CAN_DELETE_FICHE = {{ 'true' if (user.is_admin or (user.role|lower in ['codep','responsable'])) else 'false' }};

    /* Utils DOM */
    function setHTMLIfChanged(el, html){ if(!el) return; const next=(html||"").trim(); const prev=(el.innerHTML||"").trim(); if(next!==prev) el.innerHTML=html; }
    function setTextIfChanged(el, text){ if(!el) return; const next=(text||"").trim(); const prev=(el.textContent||"").trim(); if(next!==prev) el.textContent=text; }

    /* UI helpers */
    function getStatutHtml(statut){
      if(statut==='pr√©sent') return '<span class="badge present"><i class="fas fa-check-circle"></i> Pr√©sent</span>';
      if(statut==='sorti') return '<span class="badge sorti"><i class="fas fa-sign-out-alt"></i> Sorti</span>';
      if(statut==='supprim√©') return '<span class="badge supprime"><i class="fas fa-trash-alt"></i> Supprim√©</span>';
      return statut;
    }
    // Fonction pour g√©n√©rer le badge HTML c√¥t√© JS
    function getStatutEvenementHTML(statut) {
      switch (statut) {
        case "En cours de gr√©ement":
          return `<span class="badge badge-orange"><i class="fa-solid fa-hourglass-half"></i> ${statut}</span>`;
        case "Ouvert":
          return `<span class="badge badge-green"><i class="fa-solid fa-door-open"></i> ${statut}</span>`;
        case "Effectif d√©pass√©":
          return `<span class="badge badge-red"><i class="fa-solid fa-user-times"></i> ${statut}</span>`;
        case "Complet":
          return `<span class="badge badge-blue"><i class="fa-solid fa-circle-check"></i> ${statut}</span>`;
        case "Ferm√©":
          return `<span class="badge badge-dark"><i class="fa-solid fa-lock"></i> ${statut}</span>`;
        default:
          return statut;
      }
    }

    function renderCompetenceBadges(raw){
      if(!raw) return "<em>Aucune</em>";
      const colorMap={
        "M√©decin":"#e74c3c","Infirmier":"#3498db","Sapeur-pompier":"#e67e22","SST":"#1abc9c",
        "Psychologue":"#9b59b6","B√©n√©vole":"#34495e","Artisan":"#f39c12","Interpr√®te":"#2ecc71",
        "Logisticien":"#16a085","Conducteur":"#d35400","Agent s√©curit√©":"#2c3e50","Autre":"#7f8c8d"
      };
      return raw.split(',').map(c=>{
        const comp=c.trim(); const color=colorMap[comp]||"#999";
        return `<span class="badge-competence" style="background:${color}">${comp}</span>`;
      }).join(" ");
    }
    function renderBagageBadges(numeros){
      if(!numeros || !numeros.length) return '<em>Aucun</em>';
      return numeros.map(n=>`<span class="badge-bagage"><i class="fa-solid fa-suitcase-rolling"></i> ${n}</span>`).join(' ');
    }

    function actionsHTML(f){
      const delBtn = CAN_DELETE_FICHE ? `
        <form method="POST" action="/fiche/delete/${f.id}" onsubmit="return confirm('Confirmer la suppression ?');">
          <button type="submit" class="btn-action btn-red" title="Supprimer la fiche">
            <i class="fa-solid fa-trash-can"></i> <span>Supprimer</span>
          </button>
        </form>` : ``;

      return `
        <div class="actions">
          <a class="btn-action btn-blue" href="/fiche/${f.id}" title="Voir la fiche"><i class="fa-solid fa-eye"></i> <span>Voir</span></a>
          <a class="btn-action btn-yellow" href="/fiche/edit/${f.id}" title="Modifier la fiche"><i class="fa-solid fa-pen-to-square"></i> <span>Modifier</span></a>
          <button class="btn-action btn-orange" type="button" title="D√©clarer la sortie" onclick="ouvrirModalSortie(${f.id}, '${f.numero}')">
            <i class="fa-solid fa-person-walking-arrow-right"></i> <span>Sortie</span>
          </button>
          <button class="btn-action btn-orange" type="button" title="Ajouter / modifier les bagages" onclick="ouvrirModalBagage(${f.id}, '${f.numero}')">
            <i class="fa-solid fa-suitcase-rolling"></i> <span>Bagage</span>
          </button>
          ${delBtn}
        </div>`;
    }

    function ligneFicheHTML(f){
      return `
        <tr id="fiche-row-${f.id}">
          <td data-col="numero">${f.numero}</td>
          <td data-col="nom">${f.nom}</td>
          <td data-col="prenom">${f.prenom}</td>
          <td data-col="statut">${getStatutHtml(f.statut)}</td>
          <td data-col="heure_arrivee">${f.heure_arrivee}</td>
          <td data-col="difficultes">${f.difficultes || ""}</td>
          <td data-col="competences">${renderCompetenceBadges(f.competences)}</td>
          <td class="bagages-cell"><div id="bagages-${f.id}"><em>Chargement‚Ä¶</em></div></td>
          <td data-col="actions">${actionsHTML(f)}</td>
        </tr>`;
    }

    /* Cache c√¥t√© client */
    const rowsCache=new Map();

    function upsertRow(f){
      const tbody=document.getElementById("fiches-table-body");
      let tr=document.getElementById(`fiche-row-${f.id}`);
      if(!tr){
        tbody.insertAdjacentHTML('beforeend', ligneFicheHTML(f));
      }else{
        setTextIfChanged(tr.querySelector('[data-col="numero"]'), f.numero);
        setTextIfChanged(tr.querySelector('[data-col="nom"]'), f.nom);
        setTextIfChanged(tr.querySelector('[data-col="prenom"]'), f.prenom);
        setHTMLIfChanged(tr.querySelector('[data-col="statut"]'), getStatutHtml(f.statut));
        const h=tr.querySelector('[data-col="heure_arrivee"]'); if(h) setTextIfChanged(h, f.heure_arrivee);
        const d=tr.querySelector('[data-col="difficultes"]'); if(d) setTextIfChanged(d, f.difficultes || "");
        const c=tr.querySelector('[data-col="competences"]'); if(c) setHTMLIfChanged(c, renderCompetenceBadges(f.competences));
      }
      rowsCache.set(f.id, f);
      majBagagesCell(f.id);
    }

    function majBagagesCell(ficheId){
      fetch(`/fiche/${ficheId}/bagages_json`)
        .then(r=>r.json())
        .then(d=>{
          const cible=document.getElementById(`bagages-${ficheId}`);
          if(!cible) return;
          const html=(d && Array.isArray(d.numeros))? renderBagageBadges(d.numeros) : '<em>Aucun</em>';
          setHTMLIfChanged(cible, html);
        })
        .catch(()=>{
          const cible=document.getElementById(`bagages-${ficheId}`);
          setHTMLIfChanged(cible, '<em>‚Äî</em>');
        });
    }

    /* Filtres */
    function getSelectValues(sel){ return Array.from(sel.selectedOptions||[]).map(o=>o.value); }

    function rowMatchesFilters(row, f){
      const searchTerm=(document.getElementById("search-bar").value||"").toLowerCase();
      const nom=row.children[1]?.textContent.toLowerCase()||"";
      const prenom=row.children[2]?.textContent.toLowerCase()||"";
      const searchOk=!searchTerm || nom.includes(searchTerm) || prenom.includes(searchTerm);

      const selectedStatus=getSelectValues(document.getElementById('filter-statut'));
      const statutTxt=(f.statut||'').toLowerCase();
      const statusOk=selectedStatus.length===0 || selectedStatus.includes(statutTxt);

      const selectedComps=getSelectValues(document.getElementById('filter-competences'));
      const ficheComps=(f.competences||'').split(',').map(x=>x.trim()).filter(Boolean);
      const compOk=selectedComps.length===0 || ficheComps.some(c=>selectedComps.includes(c));

      return searchOk && statusOk && compOk;
    }

    function applyAllFilters(){
      const rows=document.querySelectorAll("#fiches-table-body tr");
      rows.forEach(row=>{
        const id=Number(row.id.replace('fiche-row-',''));
        const f=rowsCache.get(id);
        row.style.display=rowMatchesFilters(row,f)? "":"none";
      });
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      /* Forcer les modals ferm√©s au chargement */
      ['modal-bagage','modal-sortie'].forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.style.display='none';
      });
      /* Fermer en cliquant sur l‚Äôarri√®re-plan */
      ['modal-bagage','modal-sortie'].forEach(id=>{
        const m=document.getElementById(id);
        if(!m) return;
        m.addEventListener('click', (e)=>{ if(e.target===m) m.style.display='none'; });
      });
      /* Fermer via √âchap */
      document.addEventListener('keydown', (e)=>{
        if(e.key==='Escape'){ fermerModalBagage(); fermerModalSortie(); }
      });

      /* Filtres */
      document.getElementById("search-bar").addEventListener("input", applyAllFilters);
      document.getElementById("filter-statut").addEventListener("change", applyAllFilters);
      document.getElementById("filter-competences").addEventListener("change", applyAllFilters);
      document.getElementById("btn-reset-filters").addEventListener("click",(e)=>{
        e.preventDefault();
        document.getElementById("search-bar").value="";
        Array.from(document.getElementById("filter-statut").options).forEach(o=>o.selected=false);
        Array.from(document.getElementById("filter-competences").options).forEach(o=>o.selected=false);
        applyAllFilters();
      });

      /* Premier chargement */
      refreshFiches();
    });

    /* Rafra√Æchissement p√©riodique */
function refreshFiches(){
  fetch(`/evenement/{{ evenement.id }}/fiches_json`)
    .then(res=>res.json())
    .then(data=>{
      const idsActuels = new Set();
      data.fiches.forEach(f => {
        idsActuels.add(f.id);
        upsertRow(f);
      });

      // Suppression des lignes disparues
      Array.from(rowsCache.keys()).forEach(id => {
        if(!idsActuels.has(id)){
          const tr = document.getElementById(`fiche-row-${id}`);
          if(tr) tr.remove();
          rowsCache.delete(id);
        }
      });

      // Mise √† jour compteurs
      const nbp = document.getElementById("nb_present");
      const nbt = document.getElementById("nb_total");
      if(nbp) setTextIfChanged(nbp, String(data.nb_present));
      if(nbt) setTextIfChanged(nbt, String(data.nb_total));

      // üîÑ Mise √† jour adresse de l'√©v√©nement
      if (data.evenement && data.evenement.adresse) {
        const adrEl = document.getElementById("evt-adresse");
        if (adrEl && adrEl.textContent.trim() !== data.evenement.adresse.trim()) {
          adrEl.textContent = data.evenement.adresse;
        }
      }

      // üîÑ Mise √† jour du statut (mode √©dition)
      const statutSelect = document.getElementById("evt-statut-select");
        if (statutSelect && data.evenement && data.evenement.statut) {
          if (statutSelect.value.trim() !== data.evenement.statut.trim()) {
            statutSelect.value = data.evenement.statut.trim();
          }
        }



      // üîÑ Mise √† jour du nom de l'√©v√©nement
      if (data.evenement && data.evenement.nom) {
        const nomEl = document.getElementById("evt-nom");
        if (nomEl && nomEl.textContent.trim() !== data.evenement.nom.trim()) {
          nomEl.textContent = data.evenement.nom;
        }
        const nomInput = document.getElementById("evt-nom-input");
        if (nomInput && nomInput.value.trim() !== data.evenement.nom.trim()) {
          nomInput.value = data.evenement.nom;
        }
      }



      
            // üîÑ Mise √† jour statut de l'√©v√©nement (lecture seule avec ic√¥ne + couleur)
      if (data.evenement && data.evenement.statut) {
        const statutEl = document.getElementById("statut-lecture-seule");
        const newHTML = getStatutEvenementHTML(data.evenement.statut);
        if (statutEl && statutEl.innerHTML.trim() !== newHTML.trim()) {
          statutEl.innerHTML = newHTML;
        }
      }


      applyAllFilters();
    })
    .catch(err => console.error("Erreur refreshFiches:", err));
}
setInterval(refreshFiches, 3000);



    /* Popups */
    function ouvrirModalBagage(ficheId, ficheNumero){
      const form=document.getElementById('form-bagage');
      form.action="/fiche/"+ficheId+"/bagages/ajouter";
      document.getElementById('bagage-fiche-id').value=ficheId;
      document.getElementById('bagage-fiche-numero').value=ficheNumero||("#"+ficheId);
      document.getElementById('numeros').value="";
      fetch("/fiche/"+ficheId+"/bagages_json")
        .then(r=>r.json())
        .then(data=>{
          if(data && Array.isArray(data.numeros)){
            document.getElementById('numeros').value=data.numeros.join(", ");
          }
          document.getElementById('modal-bagage').style.display='flex';
          setTimeout(()=>document.getElementById('numeros').focus(),50);
        })
        .catch(()=>{
          document.getElementById('modal-bagage').style.display='flex';
          setTimeout(()=>document.getElementById('numeros').focus(),50);
        });
    }
    function fermerModalBagage(){ const m=document.getElementById('modal-bagage'); if(m) m.style.display='none'; }

    function ouvrirModalSortie(ficheId, ficheNumero, destination="", moyen=""){
      const form=document.getElementById('form-sortie');
      form.action="/fiche/"+ficheId+"/sortie";
      document.getElementById('sortie-fiche-id').value=ficheId;
      document.getElementById('sortie-fiche-numero').value=ficheNumero||("#"+ficheId);
      document.getElementById('sortie-destination').value=destination||"";
      document.getElementById('sortie-moyen').value=moyen||"";
      document.getElementById('modal-sortie').style.display='flex';
      setTimeout(()=>document.getElementById('sortie-destination').focus(),50);
    }
    function fermerModalSortie(){ const m=document.getElementById('modal-sortie'); if(m) m.style.display='none'; }
  </script>
</body>
</html>
