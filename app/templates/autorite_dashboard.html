{% if manage %}
<div class="card manage">
  <h3><i class="fa-solid fa-share-nodes"></i> Partage (liens publics)</h3>

  <!-- Formulaire: créer un nouveau lien -->
  <form class="row" method="POST" action="{{ url_for('main_bp.create_share_link', evenement_id=evenement.id) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button class="btn" type="submit">
      <i class="fa-solid fa-link"></i> Créer un lien
    </button>
    <a class="btn btn-secondary" href="{{ url_for('main_bp.dashboard', evenement_id=evenement.id) }}">
      <i class="fa-solid fa-arrow-left"></i> Retour dashboard
    </a>
  </form>

  <!-- Si on vient de créer un lien, on montre le VRAI lien une seule fois -->
  {% if one_time_token %}
    <div class="links" style="margin-top:12px">
      <div class="muted" style="margin-bottom:6px">
        Nouveau lien (affiché une seule fois) :
      </div>
      {% set public_url = url_for('main_bp.autorite_share_public', token=one_time_token, _external=True) %}
      <code class="share">{{ public_url }}</code>
      <div class="row" style="margin-top:8px">
        <button class="btn btn-secondary" type="button" onclick="navigator.clipboard.writeText('{{ public_url }}')">
          <i class="fa-regular fa-copy"></i> Copier
        </button>
      </div>
    </div>
  {% endif %}

  <div class="links">
    {% if links %}
      {% for l in links %}
        <div style="margin:10px 0">
          <div>
            <strong>Créé :</strong> {{ l.created_at.strftime('%d/%m/%Y %H:%M') }}
            {% if l.revoked %}<span class="muted">— (révoqué)</span>{% endif %}
          </div>

          <!-- On ne peut PAS reconstruire le lien sans le token original -->
          <code class="share">Lien non récupérable (token affiché à la création)</code>

          <div class="row" style="margin-top:6px">
            <button class="btn btn-secondary" type="button"
                    onclick="navigator.clipboard.writeText('Lien non récupérable (token affiché à la création)')">
              <i class="fa-regular fa-copy"></i> Copier
            </button>

            {% if not l.revoked %}
              <form method="POST" action="{{ url_for('main_bp.revoke_share_link', link_id=l.id) }}"
                    onsubmit="return confirm('Révoquer ce lien ?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-danger" type="submit">
                  <i class="fa-solid fa-ban"></i> Révoquer
                </button>
              </form>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p class="muted">Aucun lien pour l’instant.</p>
    {% endif %}
  </div>
</div>
{% endif %}
