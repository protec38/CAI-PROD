<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Tickets — {{ evenement.nom }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

  <style>
    :root{
      --ink:#0b1523; --muted:#6b778b; --line:#e9eef6;
      --card:#ffffff; --bg:#f4f7fb; --shadow:0 16px 40px rgba(17, 29, 56, .10);
      --blue:#003b71; --blue-2:#0a2e55; --orange:#f58220; --green:#22c55e; --red:#ef4444; --yellow:#ffcc00;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,ui-sans-serif,system-ui;color:var(--ink);background:linear-gradient(180deg,#0b2240 0%,#0b2240 20%,#f6f8fc 20%)}

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(90deg,var(--blue),#012e5a); color:#fff;
      border-bottom:3px solid var(--orange); box-shadow:0 10px 26px rgba(0,0,0,.18);
    }
    .tb-inner{max-width:1400px;margin:0 auto;display:flex;align-items:center;gap:14px;padding:12px 18px}
    .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--orange),#ff9f49);display:grid;place-items:center;color:#112944;font-weight:900;box-shadow:inset 0 2px 8px rgba(0,0,0,.2)}
    .tb-title{font-weight:900;letter-spacing:.2px}
    .tb-actions{margin-left:auto;display:flex;gap:10px}
    .btn, .btn-soft{
      display:inline-flex;align-items:center;gap:8px;cursor:pointer;border-radius:12px;padding:10px 12px;font-weight:800;border:1px solid transparent;transition:filter .15s ease, transform .04s ease;
      user-select:none;text-decoration:none
    }
    .btn:active,.btn-soft:active{transform:translateY(1px)}
    .btn{background:var(--yellow);color:#00122a;border-color:rgba(0,0,0,.08)}
    .btn-soft{background:#eef3fb;color:#0b2240;border:1px solid #d9e6ff}
    .btn-danger{background:var(--red);color:#fff;border-color:#e44e59}
    .btn:hover,.btn-soft:hover{filter:brightness(.98)}

    /* Layout */
    .wrap{max-width:1400px;margin:18px auto;padding:0 18px}
    .board{display:grid;grid-template-columns:420px 1fr;gap:16px}
    @media (max-width:1200px){.board{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--line);background:linear-gradient(90deg,#013764,#0a2e55);color:#fff}
    .card-content{padding:16px}

    /* Form */
    .field{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
    .field label{font-size:13px;color:#415165;font-weight:800}
    .field input[type="text"], .field textarea, .field select{
      padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fbfdff;outline:none
    }
    .field textarea{resize:vertical}

    /* Filters */
    .filters{
      display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;background:#f7faff;border:1px solid var(--line);
      padding:10px;border-radius:12px
    }
    .filters select,.filters input{padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}

    /* List */
    .tickets{display:grid;gap:12px}
    .ticket{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff;box-shadow:0 8px 22px rgba(17,29,56,.07)}
    .title{font-weight:900;font-size:18px;display:flex;align-items:center;gap:8px}
    .desc{color:#2b3850}
    .meta{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{
      display:inline-flex;gap:8px;align-items:center;border-radius:999px;padding:6px 10px;
      border:1px solid #dfe7f5;background:#f3f7ff;color:#0b2a55;font-weight:800;font-size:13px
    }
    .status-badge{
      display:inline-flex;align-items:center;gap:8px;font-weight:900;border-radius:999px;padding:6px 10px;border:1px solid transparent
    }
    .st-ouvert{background:#eef8ff;border-color:#d5eaff;color:#0b2a55}
    .st-encours{background:#fff7e6;border-color:#ffe1b3;color:#7b4f00}
    .st-termine{background:#effaf4;border-color:#d7f5e6;color:#0a5c35}
    .st-archive{background:#f2f2f5;border-color:#e5e7eb;color:#4b5563}

    .prio-basse{background:#eef9ff;border:1px solid #d4f0ff}
    .prio-normal{background:#eef5ff;border:1px solid #d9e6ff}
    .prio-haute{background:#ffefef;border:1px solid #ffd6d6}

    /* Toast */
    .toast{
      position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#0f172a;color:#fff;
      padding:10px 14px;border-radius:10px;display:none;z-index:9999
    }

    /* Footer small line */
    .foot{margin:24px 0 14px;color:var(--muted);font-size:12px;text-align:center}
  </style>
</head>
<body>
  <!-- TOPBAR -->
  <header class="topbar">
    <div class="tb-inner">
      <div class="logo">PC</div>
      <div class="tb-title">Tickets — {{ evenement.nom }}</div>
      <div class="tb-actions">
        <a class="btn-soft" href="{{ url_for('main_bp.dashboard', evenement_id=evenement.id) }}"><i class="fa-solid fa-arrow-left"></i> Retour dashboard</a>
      </div>
    </div>
  </header>

  <!-- CONTENT -->
  <main class="wrap">
    <div class="board">
      <!-- Colonne gauche : création -->
      <section class="card">
        <h3><i class="fa-solid fa-plus"></i> Nouveau ticket</h3>
        <div class="card-content">
          {% if can_manage %}
          <form method="POST" action="{{ url_for('main_bp.ticket_create') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="evenement_id" value="{{ evenement.id }}">

            <div class="field">
              <label>Titre *</label>
              <input type="text" name="title" maxlength="120" required placeholder="Ex : Apporter de l’eau zone C">
            </div>

            <div class="field">
              <label>Description</label>
              <textarea name="description" rows="3" maxlength="500" placeholder="Détails utiles…"></textarea>
            </div>

            <div class="field">
              <label>Catégorie</label>
              <select name="category">
                <option>Logistique</option>
                <option>Technique</option>
                <option>Secours</option>
                <option>Autre</option>
              </select>
            </div>

            <div class="field">
              <label>Priorité</label>
              <select name="priority">
                <option>Normal</option>
                <option>Haute</option>
                <option>Basse</option>
              </select>
            </div>

            <div class="field">
              <label>Assigner à</label>
              <select name="assigned_to_id">
                <option value="">— Non assigné —</option>
                {% for u in users %}
                  <option value="{{ u.id }}">{{ u.nom }} ({{ u.role }})</option>
                {% endfor %}
              </select>
            </div>

            <div class="field">
              <label>Statut initial</label>
              <select name="status">
                <option>Ouvert</option>
                <option>En cours</option>
                <option>Terminé</option>
                <option>Archivé</option>
              </select>
            </div>

            <button class="btn" type="submit"><i class="fa-solid fa-paper-plane"></i> Créer</button>
          </form>
          {% else %}
            <p style="margin:0">Vous n’avez pas les droits pour créer des tickets.</p>
          {% endif %}
        </div>
      </section>

      <!-- Colonne droite : liste -->
      <section class="card">
        <h3><i class="fa-solid fa-list-check"></i> Tous les tickets</h3>
        <div class="card-content">
          <!-- Filtres -->
          <div class="filters">
            <input id="f-search" type="text" placeholder="Recherche (titre/description)…">
            <select id="f-status">
              <option value="">(Tous statuts)</option>
              <option value="Ouvert">Ouvert</option>
              <option value="En cours">En cours</option>
              <option value="Terminé">Terminé</option>
              <option value="Archivé">Archivé</option>
            </select>
            <select id="f-priority">
              <option value="">(Toutes priorités)</option>
              <option value="Basse">Basse</option>
              <option value="Normal">Normal</option>
              <option value="Haute">Haute</option>
            </select>
            <select id="f-category">
              <option value="">(Toutes catégories)</option>
              <option value="Logistique">Logistique</option>
              <option value="Technique">Technique</option>
              <option value="Secours">Secours</option>
              <option value="Autre">Autre</option>
            </select>
            <select id="f-assignee">
              <option value="">(Tous assignés)</option>
              {% for u in users %}
                <option value="{{ u.id }}">{{ u.nom }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Liste -->
          <div id="tickets" class="tickets"><!-- injecté par JS --></div>
        </div>
      </section>
    </div>

    <div class="foot">Protection Civile — Gestion des tickets de l’évènement</div>
  </main>

  <!-- TOAST -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    /* ===== Données serveur ===== */
    const CAN_MANAGE = {{ 'true' if can_manage else 'false' }};
    const EVT_ID = {{ evenement.id }};
    const CURRENT_USER_ID = {{ user.id }};
    const USERS = [
      {% for u in users %}
        {"id": {{u.id}}, "nom": {{ u.nom|tojson }}, "role": {{ u.role|tojson }} }{{ "," if not loop.last else "" }}
      {% endfor %}
    ];

    /* ===== Helpers UI ===== */
    function showToast(msg){
      const t=document.getElementById('toast');
      t.textContent=msg; t.style.display='block';
      setTimeout(()=>{ t.style.display='none'; }, 1600);
    }

    function statusBadge(status){
      const s=(status||"").toLowerCase();
      if(s==="ouvert") return `<span class="status-badge st-ouvert"><i class="fa-regular fa-circle"></i> Ouvert</span>`;
      if(s==="en cours") return `<span class="status-badge st-encours"><i class="fa-solid fa-spinner"></i> En cours</span>`;
      if(s==="terminé"||s==="termine") return `<span class="status-badge st-termine"><i class="fa-solid fa-check"></i> Terminé</span>`;
      if(s==="archivé"||s==="archive") return `<span class="status-badge st-archive"><i class="fa-solid fa-box-archive"></i> Archivé</span>`;
      return status||"";
    }
    function prioClass(priority){
      const p=(priority||"").toLowerCase();
      if(p==="haute") return "chip prio-haute";
      if(p==="basse") return "chip prio-basse";
      return "chip prio-normal";
    }
    function fmtDateLocal(iso){
      if(!iso) return "—";
      try{ return new Date(iso).toLocaleString(); }catch{ return "—"; }
    }

    /* ===== Rendu d'une carte ===== */
    function ticketCardHTML(t){
      const prChip = `<span class="${prioClass(t.priority)}"><i class="fa-solid fa-signal"></i> ${t.priority||"—"}</span>`;
      const meIcon = (String(t.assigned_to_id) === String(CURRENT_USER_ID))
        ? `<i title="Assigné à moi" class="fa-solid fa-user-check" style="color:#22c55e"></i>` : "";
      const assigneeLabel = t.assigned_to || "—";
      const requester = t.created_by || "—";

      const managePart = CAN_MANAGE ? `
        <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
          <form onsubmit="return updateTicket(${t.id}, this);" style="display:flex; gap:8px; flex-wrap:wrap">
            <select name="status">
              ${["Ouvert","En cours","Terminé","Archivé"].map(s=>`<option ${s===t.status?"selected":""}>${s}</option>`).join("")}
            </select>
            <select name="priority">
              ${["Basse","Normal","Haute"].map(s=>`<option ${s===t.priority?"selected":""}>${s}</option>`).join("")}
            </select>
            <select name="category">
              ${["Logistique","Technique","Secours","Autre"].map(s=>`<option ${s===t.category?"selected":""}>${s}</option>`).join("")}
            </select>
            <select name="assigned_to_id">
              <option value="">— Non assigné —</option>
              ${USERS.map(u=>`<option value="${u.id}" ${String(t.assigned_to_id)===String(u.id)?"selected":""}>${u.nom} (${u.role})</option>`).join("")}
            </select>
            <button class="btn-soft" type="submit"><i class="fa-solid fa-floppy-disk"></i> Enregistrer</button>
          </form>
          <form method="POST" action="/tickets/${t.id}/delete" onsubmit="return confirm('Supprimer ce ticket ?')">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn-soft btn-danger" type="submit"><i class="fa-solid fa-trash-can"></i> Supprimer</button>
          </form>
        </div>` : ``;

      return `
        <div class="ticket" id="ticket-${t.id}">
          <div class="title">${meIcon}${t.title||"—"}</div>
          <div class="meta">
            <span class="chip"><i class="fa-solid fa-user"></i> Demandeur&nbsp;: ${requester}</span>
            <span class="chip"><i class="fa-solid fa-user-gear"></i> Assigné&nbsp;: ${assigneeLabel}</span>
            ${prChip}
            <span class="chip"><i class="fa-solid fa-tags"></i> ${t.category||"—"}</span>
            <span class="chip"><i class="fa-regular fa-clock"></i> ${fmtDateLocal(t.created_at)}</span>
            ${statusBadge(t.status)}
          </div>
          ${t.description ? `<div class="desc" style="margin-top:6px">${t.description}</div>`:``}
          ${managePart}
        </div>`;
    }

    /* ===== Filtres ===== */
    function applyFilters(list){
      const q = (document.getElementById('f-search').value || '').toLowerCase().trim();
      const st = document.getElementById('f-status').value;
      const pr = document.getElementById('f-priority').value;
      const cat = document.getElementById('f-category').value;
      const asg = document.getElementById('f-assignee').value;

      return list.filter(t=>{
        const hay = ((t.title||"") + " " + (t.description||"")).toLowerCase();
        const qok = !q || hay.includes(q);
        const sok = !st || (t.status===st);
        const pok = !pr || (t.priority===pr);
        const cok = !cat || (t.category===cat);
        const aok = !asg || (String(t.assigned_to_id||"")===String(asg));
        return qok && sok && pok && cok && aok;
      });
    }

    function renderTickets(list){
      const wrap = document.getElementById("tickets");
      wrap.innerHTML = list.map(ticketCardHTML).join("");
    }

    /* ===== Update AJAX ===== */
    async function updateTicket(id, form){
      const fd = new FormData(form);
      try{
        const res = await fetch(`/tickets/${id}/update`, { method:"POST", body: fd });
        if(res.ok){ showToast("✅ Ticket mis à jour"); refreshTickets(); }
        else { showToast("⚠️ Erreur mise à jour"); }
      }catch(e){ showToast("⚠️ Erreur réseau"); }
      return false;
    }

    /* ===== Polling ===== */
    let lastHash = "";
    const hash = (obj)=> JSON.stringify(obj);

    async function refreshTickets(){
      try{
        const res = await fetch(`/evenement/${EVT_ID}/tickets_json`, { cache: "no-store" });
        if(!res.ok){ console.error("tickets_json status", res.status); return; }
        const data = await res.json();
        const list = Array.isArray(data.tickets) ? data.tickets : [];
        const filtered = applyFilters(list);
        const h = hash(filtered);
        if(h !== lastHash){
          renderTickets(filtered);
          if(lastHash) showToast("🔔 Tickets actualisés");
          lastHash = h;
        }
      }catch(e){ console.error("Erreur fetch tickets :", e); }
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      ['f-search','f-status','f-priority','f-category','f-assignee'].forEach(id=>{
        const el=document.getElementById(id);
        if(!el) return;
        const evt = (el.tagName==='SELECT') ? 'change' : 'input';
        el.addEventListener(evt, refreshTickets);
      });
      refreshTickets();
      setInterval(refreshTickets, 3000);
    });
  </script>
</body>
</html>
