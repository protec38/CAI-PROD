<!-- templates/tickets_board.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tickets – {{ evenement.nom }}</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

  <style>
    :root{
      --pc-blue:#003b71; --pc-blue-2:#0a2e55;
      --pc-orange:#f58220; --pc-yellow:#ffcc00;
      --bg:#0b2240; --bg2:#f6f8fc; --ink:#0b1523; --muted:#6b778b; --line:#e7edf5;
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --card:#ffffff; --radius:16px; --shadow:0 14px 36px rgba(17,29,56,.12);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,ui-sans-serif,system-ui;background:linear-gradient(180deg,var(--bg) 0%,var(--bg) 24%,var(--bg2) 24%);color:var(--ink);min-height:100dvh}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:50;background:linear-gradient(90deg,var(--pc-blue),#012e5a);color:#fff;border-bottom:3px solid var(--pc-orange);padding:12px 16px;box-shadow:0 8px 20px rgba(0,0,0,.18)}
    .tb-inner{max-width:1200px;margin:0 auto;display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--pc-orange),#ff9f49);display:grid;place-items:center;color:#112944;font-weight:900;box-shadow:inset 0 2px 8px rgba(0,0,0,.2)}
    .tb-title{font-weight:900;letter-spacing:.2px}
    .right{margin-left:auto;display:flex;gap:10px}
    .btn-top{display:inline-flex;align-items:center;gap:8px;background:#ffeb8a;color:#00122a;border:1px solid rgba(0,0,0,.12);padding:10px 12px;border-radius:10px;font-weight:900}

    /* Layout */
    .wrap{max-width:1200px;margin:18px auto;padding:14px}
    .hero{background:linear-gradient(135deg,rgba(0,47,108,.96),rgba(245,130,32,.92));color:#fff;border-radius:18px;padding:20px 18px;box-shadow:var(--shadow)}
    .hero h2{margin:0 0 6px 0}
    .hero .muted{color:#f1f5f9}

    .board{display:grid;grid-template-columns:360px 1fr;gap:16px;margin-top:14px}
    @media (max-width:1000px){.board{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--line);background:#f8fbff;font-weight:900}
    .card-content{padding:14px 16px}

    /* Forms */
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .field label{font-weight:800;font-size:14px}
    .field input[type="text"],
    .field textarea,
    .field select{border:1px solid #d8dee9;border-radius:12px;padding:10px 12px;font-size:14px;background:#fff}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid transparent;padding:10px 12px;border-radius:10px;font-weight:900;cursor:pointer;background:var(--pc-yellow);color:#00122a;border-color:rgba(0,0,0,.12)}
    .btn:hover{filter:brightness(.98)}
    .btn-soft{display:inline-flex;align-items:center;gap:8px;border:1px solid #dfe7f1;background:#eef2f7;color:#111;padding:8px 10px;border-radius:10px;font-weight:800;cursor:pointer}
    .btn-danger{background:var(--err);border-color:#e44e59;color:#fff}

    /* Filters */
    .filters{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .filters select,.filters input{border:1px solid #d8dee9;border-radius:10px;padding:10px;min-width:160px}

    /* Tickets list */
    .tickets{display:grid;gap:12px}
    .ticket{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff;box-shadow:0 10px 20px rgba(17,29,56,.06)}
    .title{font-weight:900;font-size:16px;display:flex;gap:8px;align-items:center}
    .desc{color:#1f2937}
    .meta{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#f2f6fb;border:1px solid #dbe6f6;border-radius:999px;padding:6px 9px;font-weight:800;font-size:13px}

    .status-badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:6px 9px;font-weight:900}
    .st-ouvert{background:#eef5ff;border:1px solid #cfe0ff;color:#0b2a55}
    .st-encours{background:#fff7e6;border:1px solid #ffe2b3;color:#8a4a00}
    .st-termine{background:#eaf9f0;border:1px solid #c8efd7;color:#0f6848}
    .st-archive{background:#f3f4f6;border:1px solid #e5e7eb;color:#374151}

    .prio-haute{background:#ffefef;border-color:#ffd6d6;color:#8d0f0f}
    .prio-normal{background:#eef7ff;border-color:#d9e6ff;color:#0b2a55}
    .prio-basse{background:#ecfff2;border-color:#cbf7db;color:#0b5d2b}

    /* Toast */
    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111827;color:#fff;
           padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .2s,transform .2s;z-index:60}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}
  </style>
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="tb-inner">
      <div class="logo">PC</div>
      <div class="tb-title"><i class="fa-solid fa-ticket"></i>&nbsp; Tickets – {{ evenement.nom }}</div>
      <div class="right">
        <a class="btn-top" href="{{ url_for('main_bp.dashboard', evenement_id=evenement.id) }}"><i class="fa-solid fa-arrow-left"></i> Retour dashboard</a>
      </div>
    </div>
  </header>

  <!-- Bandeau -->
  <div class="wrap">
    <div class="hero" role="banner">
      <h2 style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
        <i class="fa-solid fa-clipboard-list"></i>
        Gestion des tickets de l’évènement
      </h2>
      <div class="muted">Créez, assignez et suivez les demandes en temps réel. Filtrez par statut, priorité, catégorie ou personne assignée.</div>
    </div>

    <div class="board">
      <!-- Colonne création -->
      <div class="card">
        <h3><i class="fa-solid fa-plus"></i> Nouveau ticket</h3>
        <div class="card-content">
          {% if can_manage %}
          <form method="POST" action="{{ url_for('main_bp.ticket_create') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="evenement_id" value="{{ evenement.id }}">

            <div class="field">
              <label>Titre *</label>
              <input type="text" name="title" maxlength="120" required placeholder="Ex : Apporter de l’eau zone C">
            </div>
            <div class="field">
              <label>Description</label>
              <textarea name="description" rows="3" maxlength="500" placeholder="Détails utiles…"></textarea>
            </div>
            <div class="field">
              <label>Catégorie</label>
              <select name="category">
                <option>Logistique</option>
                <option>Technique</option>
                <option>Secours</option>
                <option>Autre</option>
              </select>
            </div>
            <div class="field">
              <label>Priorité</label>
              <select name="priority">
                <option>Normal</option>
                <option>Haute</option>
                <option>Basse</option>
              </select>
            </div>
            <div class="field">
              <label>Assigner à</label>
              <select name="assigned_to_id">
                <option value="">— Non assigné —</option>
                {% for u in users %}
                  <option value="{{ u.id }}">{{ u.nom }} ({{ u.role }})</option>
                {% endfor %}
              </select>
            </div>
            <div class="field">
              <label>Statut initial</label>
              <select name="status">
                <option>Ouvert</option>
                <option>En cours</option>
                <option>Terminé</option>
                <option>Archivé</option>
              </select>
            </div>

            <button class="btn" type="submit"><i class="fa-solid fa-paper-plane"></i> Créer</button>
          </form>
          {% else %}
            <p style="margin:0">Vous n’avez pas les droits pour créer des tickets.</p>
          {% endif %}
        </div>
      </div>

      <!-- Colonne liste -->
      <div class="card">
        <h3><i class="fa-solid fa-list-check"></i> Tous les tickets</h3>
        <div class="card-content">

          <!-- Filtres -->
          <div class="filters">
            <input id="f-search" type="text" placeholder="Recherche (titre/description)…">
            <select id="f-status">
              <option value="">(Tous statuts)</option>
              <option value="Ouvert">Ouvert</option>
              <option value="En cours">En cours</option>
              <option value="Terminé">Terminé</option>
              <option value="Archivé">Archivé</option>
            </select>
            <select id="f-priority">
              <option value="">(Toutes priorités)</option>
              <option value="Basse">Basse</option>
              <option value="Normal">Normal</option>
              <option value="Haute">Haute</option>
            </select>
            <select id="f-category">
              <option value="">(Toutes catégories)</option>
              <option value="Logistique">Logistique</option>
              <option value="Technique">Technique</option>
              <option value="Secours">Secours</option>
              <option value="Autre">Autre</option>
            </select>
            <select id="f-assignee">
              <option value="">(Tous assignés)</option>
              {% for u in users %}
                <option value="{{ u.id }}">{{ u.nom }}</option>
              {% endfor %}
            </select>
          </div>

          <div id="tickets" class="tickets"><!-- injecté par JS --></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">Action effectuée</div>

  <script>
    /* ===== Données passées par le serveur ===== */
    const CAN_MANAGE = {{ 'true' if can_manage else 'false' }};
    const EVT_ID = {{ evenement.id }};
    const CURRENT_USER_ID = {{ user.id }};
    const USERS = [
      {% for u in users %}
        {"id": {{u.id}}, "nom": {{ u.nom|tojson }}, "role": {{ u.role|tojson }} }{{ "," if not loop.last else "" }}
      {% endfor %}
    ];

    /* ===== Helpers ===== */
    function toast(msg){
      const t=document.getElementById('toast');
      if(!t) return;
      t.textContent = msg || 'Action effectuée';
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 1500);
    }
    function statusBadge(status){
      const s=(status||"").toLowerCase();
      if(s==="ouvert") return `<span class="status-badge st-ouvert"><i class="fa-regular fa-circle"></i> Ouvert</span>`;
      if(s==="en cours") return `<span class="status-badge st-encours"><i class="fa-solid fa-spinner"></i> En cours</span>`;
      if(s==="terminé"||s==="termine") return `<span class="status-badge st-termine"><i class="fa-solid fa-check"></i> Terminé</span>`;
      if(s==="archivé"||s==="archive") return `<span class="status-badge st-archive"><i class="fa-solid fa-box-archive"></i> Archivé</span>`;
      return status||"";
    }
    function prioClass(priority){
      const p=(priority||"").toLowerCase();
      if(p==="haute") return "prio-haute";
      if(p==="basse") return "prio-basse";
      return "prio-normal";
    }
    function fmtDateIsoLocalPlus2(iso){
      if(!iso) return "—";
      try{
        const d = new Date(iso);
        const adjusted = new Date(d.getTime() + 120*60*1000); // heuristique +2h si besoin
        return adjusted.toLocaleString();
      }catch{ return "—"; }
    }
    function assigneeNameById(id){
      const u = USERS.find(x=>String(x.id)===String(id));
      return u ? `${u.nom} (${u.role})` : "—";
    }

    /* ===== Carte ticket ===== */
    function ticketCardHTML(t){
      const prChip = `<span class="chip ${prioClass(t.priority)}"><i class="fa-solid fa-signal"></i> ${t.priority||"—"}</span>`;
      const meIcon = (String(t.assigned_to_id) === String(CURRENT_USER_ID)) ? `<i title="Assigné à moi" class="fa-solid fa-user-check" style="color:#22c55e"></i>` : "";
      const assigneeLabel = t.assigned_to || assigneeNameById(t.assigned_to_id);

      const managePart = CAN_MANAGE ? `
        <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
          <form onsubmit="return updateTicket(${t.id}, this);" style="display:flex; gap:8px; flex-wrap:wrap">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <select name="status">
              ${["Ouvert","En cours","Terminé","Archivé"].map(s=>`<option ${s===t.status?"selected":""}>${s}</option>`).join("")}
            </select>
            <select name="priority">
              ${["Basse","Normal","Haute"].map(s=>`<option ${s===t.priority?"selected":""}>${s}</option>`).join("")}
            </select>
            <select name="category">
              ${["Logistique","Technique","Secours","Autre"].map(s=>`<option ${s===t.category?"selected":""}>${s}</option>`).join("")}
            </select>
            <select name="assigned_to_id">
              <option value="">— Non assigné —</option>
              ${USERS.map(u=>`<option value="${u.id}" ${String(t.assigned_to_id)===String(u.id)?"selected":""}>${u.nom} (${u.role})</option>`).join("")}
            </select>
            <button class="btn-soft" type="submit"><i class="fa-solid fa-floppy-disk"></i> Enregistrer</button>
          </form>
          <form method="POST" action="/tickets/${t.id}/delete" onsubmit="return confirm('Supprimer ce ticket ?')">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn-soft btn-danger" type="submit"><i class="fa-solid fa-trash-can"></i> Supprimer</button>
          </form>
        </div>` : ``;

      return `
        <div class="ticket" id="ticket-${t.id}">
          <div class="title">${meIcon}${t.title}</div>
          <div class="meta">
            <span class="chip"><i class="fa-solid fa-user"></i> Demandeur&nbsp;: ${t.created_by||"—"}</span>
            <span class="chip"><i class="fa-solid fa-user-gear"></i> Assigné&nbsp;: ${assigneeLabel||"—"}</span>
            ${prChip}
            <span class="chip"><i class="fa-solid fa-tags"></i> ${t.category||"—"}</span>
            <span class="chip"><i class="fa-regular fa-clock"></i> ${fmtDateIsoLocalPlus2(t.created_at)}</span>
            ${statusBadge(t.status)}
          </div>
          ${t.description ? `<div class="desc" style="margin-top:6px">${t.description}</div>`:``}
          ${managePart}
        </div>`;
    }

    /* ===== AJAX update (CSRF inclus) ===== */
    async function updateTicket(id, form){
      const fd = new FormData(form);
      const csrf = document.querySelector('meta[name="csrf-token"]')?.content || '';
      if(csrf) fd.set('csrf_token', csrf);

      try{
        const res = await fetch(`/tickets/${id}/update`, { method:"POST", body: fd, cache:"no-store" });
        if(res.ok){
          toast("✅ Ticket mis à jour");
          refreshTickets();
        }else{
          const txt = await res.text();
          toast(`⚠️ Erreur (${res.status})`);
          console.error("Update ticket failed:", res.status, txt);
        }
      }catch(e){
        toast("⚠️ Erreur réseau");
        console.error(e);
      }
      return false; // empêcher la soumission classique
    }

    /* ===== Filtres ===== */
    function applyFilters(list){
      const q = (document.getElementById('f-search').value || '').toLowerCase().trim();
      const st = document.getElementById('f-status').value;
      const pr = document.getElementById('f-priority').value;
      const cat = document.getElementById('f-category').value;
      const asg = document.getElementById('f-assignee').value;

      return list.filter(t=>{
        const hay = ((t.title||"") + " " + (t.description||"")).toLowerCase();
        const qok = !q || hay.includes(q);
        const sok = !st || (t.status===st);
        const pok = !pr || (t.priority===pr);
        const cok = !cat || (t.category===cat);
        const aok = !asg || (String(t.assigned_to_id||"")===String(asg));
        return qok && sok && pok && cok && aok;
      });
    }

    function renderTickets(list){
      const wrap = document.getElementById("tickets");
      wrap.innerHTML = list.map(ticketCardHTML).join("");
    }

    /* ===== Polling ===== */
    let lastHash = "";
    const hash = (obj)=> JSON.stringify(obj);

    async function refreshTickets(){
      try{
        const res = await fetch(`/evenement/${EVT_ID}/tickets_json`, {cache:"no-store"});
        if(!res.ok){ console.error("tickets_json status", res.status); return; }
        const data = await res.json();
        const list = Array.isArray(data.tickets) ? data.tickets : [];
        const filtered = applyFilters(list);
        const h = hash(filtered);
        if(h !== lastHash){
          renderTickets(filtered);
          if(lastHash) toast("🔔 Tickets actualisés");
          lastHash = h;
        }
      }catch(e){ console.error("Erreur fetch tickets :", e); }
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      ['f-search','f-status','f-priority','f-category','f-assignee'].forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.addEventListener('input', refreshTickets);
        if(el && el.tagName==='SELECT') el.addEventListener('change', refreshTickets);
      });
      refreshTickets();
      setInterval(refreshTickets, 3000);
    });
  </script>
</body>
</html>
