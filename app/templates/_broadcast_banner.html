{% if not (hide_broadcast | default(false)) %}
<div id="cai-broadcast-root"
     data-status-url="{{ url_for('main_bp.get_broadcast_status') }}"
     data-auto-clear="{{ (broadcast_auto_clear_seconds | default(15)) * 1000 }}"
     data-poll-interval="5000"
     data-initial='{{ (active_broadcast.as_payload() if active_broadcast else none) | tojson }}'>
</div>
<style>
  #cai-broadcast-banner {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translate(-50%, -40px);
    background: #111827;
    color: #f9fafb;
    padding: 16px 20px;
    border-radius: 18px;
    box-shadow: 0 18px 36px rgba(15, 23, 42, 0.3);
    max-width: min(640px, calc(100vw - 32px));
    width: max-content;
    opacity: 0;
    transition: opacity .25s ease, transform .25s ease;
    z-index: 9999;
  }
  #cai-broadcast-banner.is-visible {
    opacity: 1;
    transform: translate(-50%, 0);
  }
  #cai-broadcast-banner.is-hidden {
    opacity: 0;
    transform: translate(-50%, -40px);
    pointer-events: none;
  }
  #cai-broadcast-banner[data-level="info"] {
    background: #1d4ed8;
    box-shadow: 0 18px 36px rgba(30, 64, 175, 0.36);
  }
  #cai-broadcast-banner[data-level="success"] {
    background: #15803d;
    box-shadow: 0 18px 36px rgba(22, 101, 52, 0.36);
  }
  #cai-broadcast-banner[data-level="warning"] {
    background: #92400e;
    box-shadow: 0 18px 36px rgba(146, 64, 14, 0.36);
  }
  #cai-broadcast-banner[data-level="danger"],
  #cai-broadcast-banner[data-level="critical"] {
    background: #991b1b;
    box-shadow: 0 18px 36px rgba(153, 27, 27, 0.36);
  }
  .cai-broadcast__content {
    display: flex;
    align-items: flex-start;
    gap: 16px;
  }
  .cai-broadcast__icon {
    font-size: 1.8rem;
    line-height: 1;
  }
  .cai-broadcast__body {
    flex: 1 1 auto;
  }
  .cai-broadcast__title {
    margin: 0 0 4px;
    font-weight: 700;
    letter-spacing: .02em;
    text-transform: uppercase;
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.75);
  }
  .cai-broadcast__message {
    margin: 0;
    font-size: 1rem;
    line-height: 1.5;
  }
  .cai-broadcast__close {
    background: rgba(255, 255, 255, 0.1);
    color: #f9fafb;
    border: none;
    border-radius: 999px;
    width: 32px;
    height: 32px;
    font-size: 1.2rem;
    line-height: 1;
    cursor: pointer;
    transition: background .2s ease;
  }
  .cai-broadcast__close:hover,
  .cai-broadcast__close:focus-visible {
    background: rgba(255, 255, 255, 0.24);
    outline: none;
  }
  @media (max-width: 480px) {
    #cai-broadcast-banner {
      padding: 14px 16px;
    }
    .cai-broadcast__content {
      gap: 12px;
    }
  }
</style>
<script>
(function(){
  const root = document.getElementById('cai-broadcast-root');
  if (!root) { return; }

  const statusUrl = root.dataset.statusUrl;
  if (!statusUrl) { return; }

  const config = {
    autoClearMs: Number(root.dataset.autoClear || 15000),
    pollInterval: Number(root.dataset.pollInterval || 10000),
    lastPayloadKey: null,
    hideTimer: null,
  };

  const parseInitial = () => {
    const raw = root.dataset.initial;
    if (!raw) { return null; }
    try { return JSON.parse(raw); } catch (error) { return null; }
  };

  const state = {
    payload: parseInitial(),
  };

  const hideBanner = (immediate = false) => {
    const banner = document.getElementById('cai-broadcast-banner');
    if (!banner) { return; }
    banner.classList.add('is-hidden');
    banner.classList.remove('is-visible');
    const remove = () => {
      if (banner && banner.parentElement) {
        banner.parentElement.removeChild(banner);
      }
    };
    if (immediate) {
      remove();
      return;
    }
    window.setTimeout(remove, 320);
  };

  const scheduleAutoHide = () => {
    if (config.hideTimer) {
      window.clearTimeout(config.hideTimer);
    }
    if (!config.autoClearMs || config.autoClearMs <= 0) {
      return;
    }
    config.hideTimer = window.setTimeout(() => hideBanner(), config.autoClearMs);
  };

  const renderBanner = (payload) => {
    if (!payload) {
      hideBanner(true);
      config.lastPayloadKey = null;
      state.payload = null;
      window.dispatchEvent(new CustomEvent('cai:broadcast:update', { detail: { active: null } }));
      return;
    }

    let banner = document.getElementById('cai-broadcast-banner');
    if (!banner) {
      banner = document.createElement('div');
      banner.id = 'cai-broadcast-banner';
      banner.className = 'is-hidden';
      banner.setAttribute('role', 'alert');
      banner.setAttribute('aria-live', 'assertive');

      const content = document.createElement('div');
      content.className = 'cai-broadcast__content';

      const icon = document.createElement('div');
      icon.className = 'cai-broadcast__icon';
      icon.setAttribute('aria-hidden', 'true');
      content.appendChild(icon);

      const body = document.createElement('div');
      body.className = 'cai-broadcast__body';

      const title = document.createElement('p');
      title.className = 'cai-broadcast__title';
      title.textContent = 'Information centre';
      body.appendChild(title);

      const message = document.createElement('p');
      message.className = 'cai-broadcast__message';
      body.appendChild(message);

      content.appendChild(body);

      const close = document.createElement('button');
      close.className = 'cai-broadcast__close';
      close.type = 'button';
      close.setAttribute('aria-label', 'Fermer la notification');
      close.innerHTML = '&times;';
      close.addEventListener('click', () => hideBanner(true));

      banner.appendChild(content);
      banner.appendChild(close);
      document.body.appendChild(banner);
      window.requestAnimationFrame(() => {
        banner.classList.remove('is-hidden');
        banner.classList.add('is-visible');
      });
    }

    banner.dataset.level = payload.level || 'warning';
    const iconEl = banner.querySelector('.cai-broadcast__icon');
    if (iconEl) {
      iconEl.textContent = payload.emoji || '⚠️';
    }
    const messageEl = banner.querySelector('.cai-broadcast__message');
    if (messageEl) {
      const safeMessage = (payload.message || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/\n/g, '<br>');
      messageEl.innerHTML = safeMessage;
    }

    banner.classList.remove('is-hidden');
    banner.classList.add('is-visible');

    state.payload = payload;
    config.lastPayloadKey = JSON.stringify([
      payload.id,
      payload.message,
      payload.emoji,
      payload.level,
      payload.created_at,
    ]);

    window.dispatchEvent(new CustomEvent('cai:broadcast:update', { detail: { active: payload } }));
    scheduleAutoHide();
  };

  const maybeUpdate = (payload) => {
    if (!payload) {
      if (state.payload) {
        hideBanner();
      }
      state.payload = null;
      config.lastPayloadKey = null;
      window.dispatchEvent(new CustomEvent('cai:broadcast:update', { detail: { active: null } }));
      return;
    }

    const key = JSON.stringify([
      payload.id,
      payload.message,
      payload.emoji,
      payload.level,
      payload.created_at,
    ]);
    if (config.lastPayloadKey === key) {
      return;
    }
    renderBanner(payload);
  };

  const fetchStatus = async () => {
    try {
      const response = await fetch(statusUrl, {
        headers: {
          'Accept': 'application/json',
        },
        credentials: 'same-origin',
      });
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      const payload = await response.json();
      if (typeof payload?.autoClearSeconds === 'number') {
        config.autoClearMs = Math.max(2000, payload.autoClearSeconds * 1000);
      }
      maybeUpdate(payload?.active || null);
    } catch (error) {
      console.error('[Broadcast] Impossible de récupérer le statut', error);
    }
  };

  const initial = state.payload;
  if (initial) {
    renderBanner(initial);
  }

  if (config.pollInterval > 0) {
    fetchStatus();
    window.setInterval(fetchStatus, config.pollInterval);
  }

  document.addEventListener('cai:broadcast:refresh', fetchStatus);
})();
</script>
{% endif %}
